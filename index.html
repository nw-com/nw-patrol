<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>西北保全巡邏打卡系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        /* 全局樣式和字體 */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent; /* 移除行動裝置點擊高亮 */
        }
        /* 頁面容器，符合上下 50px, 左右 10px 的邊界要求 */
        #main-page-container {
            position: fixed;
            top: 50px;
            left: 10px;
            right: 10px;
            bottom: 50px;
            display: flex;
            flex-direction: column;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        /* 頁首和頁尾的固定高度 */
        #main-header, #main-footer {
            height: 70px;
            flex-shrink: 0;
        }
        /* 頁中內容區域填滿剩餘空間 */
        #main-content {
            flex-grow: 1;
            overflow-y: auto; /* 當內容過多時，允許滾動 */
            background-color: #f9fafb; /* 頁中背景色 */
        }
        /* 導航按鈕的活動狀態 */
        .nav-btn.active {
            color: #ef4444; /* 紅色 */
            background-color: #fee2e2; /* 淡紅色背景 */
        }
        /* 讓表格在小螢幕上可以滾動 */
        .table-container {
            overflow-x: auto;
        }
        #map-container, #map-preview-container {
            height: 400px;
            width: 100%;
        }

        /* 列印樣式 */
        @media print {
            @page {
                size: A4;
                margin: 1cm;
            }
            body > * {
                display: none;
            }
            #print-area, #print-area * {
                display: block;
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            #log-details-modal {
                box-shadow: none;
                border: none;
                position: static;
                width: 100%;
                max-width: 100%;
            }
            #log-details-modal h3, #log-details-modal .items-center {
                display: none;
            }
            #print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 2rem;
                border-bottom: 1px solid #ccc;
                padding-bottom: 1rem;
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            th, td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            th {
                background-color: #f2f2f2;
            }
            tr.bg-green-50 {
                background-color: #e6ffed !important;
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }
            tr.bg-red-50 {
                background-color: #ffe5e5 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .print-hide {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- App 根容器 -->
    <div id="app">

        <!-- 登入頁面 -->
        <div id="login-page" class="flex items-center justify-center min-h-screen p-4">
            <div class="w-full max-w-sm mx-auto bg-white p-8 rounded-2xl shadow-lg text-center">
                <!-- Logo -->
                <svg class="mx-auto h-12 w-auto text-red-500 mb-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">西北保全巡邏打卡系統</h1>
                <p class="text-center text-gray-500 mb-6">請登入您的帳號</p>
                <form id="login-form">
                    <div class="mb-4 text-left">
                        <div class="flex justify-between items-center mb-1">
                            <label for="email" class="block text-sm font-medium text-gray-700">帳號 (Email)</label>
                            <div class="flex items-center">
                                <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                                <label for="remember-me" class="ml-2 block text-sm text-gray-900">記住我</label>
                            </div>
                        </div>
                        <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="user@example.com" required>
                    </div>
                    <div class="mb-6 text-left">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密碼</label>
                        <div class="relative">
                            <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="••••••••" required>
                            <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500">
                                <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                <svg id="eye-off-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        登入
                    </button>
                    <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
                </form>
            </div>
        </div>

        <!-- 主應用程式頁面 (登入後顯示) -->
        <div id="main-page" class="hidden">
            <div id="main-page-container" class="bg-white">
                <!-- 頁首 -->
                <header id="main-header" class="bg-white border-b border-gray-200 flex items-center justify-between px-4">
                    <div class="flex items-center space-x-2 min-w-0">
                        <svg class="h-8 w-8 text-red-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                        <div class="min-w-0">
                             <h1 class="text-md sm:text-xl font-bold text-gray-800 truncate">西北保全巡邏打卡系統</h1>
                        </div>
                    </div>
                    <div class="relative">
                         <button id="welcome-button" class="text-sm font-semibold text-gray-700 truncate p-2 rounded-md hover:bg-gray-100"></button>
                         <div id="logout-popup" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-xl z-20 py-1">
                             <div class="px-4 py-2 text-sm text-gray-700">確定要登出嗎？</div>
                             <div class="flex justify-around p-2">
                                 <button id="confirm-logout-btn" class="text-sm bg-red-500 text-white rounded-md px-3 py-1 hover:bg-red-600">登出</button>
                                 <button id="cancel-logout-btn" class="text-sm bg-gray-200 text-gray-800 rounded-md px-3 py-1 hover:bg-gray-300">取消</button>
                             </div>
                         </div>
                    </div>
                </header>

                <!-- 頁中 (主要內容) -->
                <main id="main-content" class="p-4">
                    <!-- 各分頁內容會在這裡切換顯示 -->
                    <div id="page-home" class="page-content">
                        <h2 class="text-2xl font-bold mb-4">首頁</h2>
                        <div class="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded-lg">
                            <p class="font-bold">歡迎使用！</p>
                            <p>請點擊下方導航按鈕開始操作。</p>
                        </div>
                         <div class="mt-6">
                            <h3 class="font-semibold text-lg mb-2">系統狀態</h3>
                            <div class="p-4 bg-white rounded-lg shadow-sm space-y-2">
                                <p><strong>NFC 功能:</strong> <span id="nfc-status">檢測中...</span></p>
                                <p><strong>Firebase 連線:</strong> <span id="firebase-status" class="text-gray-400">尚未連接</span></p>
                            </div>
                        </div>
                    </div>

                    <div id="page-patrol" class="page-content hidden">
                        <h2 class="text-2xl font-bold mb-4">今日巡邏任務</h2>
                        <div id="todays-patrols-list" class="space-y-4">
                           <!-- Today's patrols will be loaded here -->
                        </div>
                         <div id="nfc-scan-area" class="hidden mt-6 text-center p-6 bg-white border-2 border-dashed border-gray-300 rounded-lg">
                            <p id="nfc-scan-area-title" class="font-bold text-lg mb-2"></p>
                            <p class="text-gray-600 mb-4">請將手機靠近 NFC 標籤進行感應。</p>
                            <div id="nfc-log" class="mt-6 text-left text-sm text-gray-700 bg-gray-50 p-4 rounded-lg h-48 overflow-y-auto">
                                <p class="text-gray-400">掃描紀錄將顯示於此...</p>
                            </div>
                        </div>
                    </div>

                    <div id="page-data" class="page-content hidden">
                        <h2 class="text-2xl font-bold mb-4">今日巡邏紀錄</h2>
                        <div id="data-logs-container" class="space-y-4">
                            <!-- Daily log summaries will be loaded here -->
                        </div>
                    </div>

                    <div id="page-schedule" class="page-content hidden space-y-6">
                        <div>
                             <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-gray-800">排程管理</h2>
                                <button id="add-schedule-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">新增排程</button>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label for="filter-community" class="block text-sm font-medium text-gray-700">依社區篩選</label>
                                    <select id="filter-community" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md">
                                    </select>
                                </div>
                                <div>
                                     <label for="filter-user" class="block text-sm font-medium text-gray-700">依人員篩選</label>
                                    <select id="filter-user" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md">
                                    </select>
                                </div>
                                <div class="self-end">
                                    <button id="clear-filters-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg text-sm">清除篩選</button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow overflow-hidden table-container">
                             <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-4 py-3">社區名稱</th>
                                        <th scope="col" class="px-4 py-3">巡邏編號</th>
                                        <th scope="col" class="px-4 py-3">巡邏點</th>
                                        <th scope="col" class="px-4 py-3">排程時間</th>
                                        <th scope="col" class="px-4 py-3">人員</th>
                                        <th scope="col" class="px-4 py-3 text-right">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="schedules-list">
                                    <!-- Schedule data will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="page-settings" class="page-content hidden space-y-8">
                        <!-- 服務社區管理 -->
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-800">服務社區列表</h3>
                                <button id="add-community-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">新增社區</button>
                            </div>
                            <div class="bg-white rounded-lg shadow overflow-hidden table-container">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-4 py-3">社區編號</th>
                                            <th scope="col" class="px-4 py-3">社區名稱</th>
                                            <th scope="col" class="px-4 py-3">GPS位置</th>
                                            <th scope="col" class="px-4 py-3 text-right">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="communities-list">
                                        <!-- Data will be populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    
                        <!-- 帳號管理 -->
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-800">帳號列表</h3>
                                <button id="add-user-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">新增帳號</button>
                            </div>
                            <div class="bg-white rounded-lg shadow table-container">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-4 py-3">角色</th>
                                            <th scope="col" class="px-4 py-3">姓名</th>
                                            <th scope="col" class="px-4 py-3">電子郵件(帳號)</th>
                                            <th scope="col" class="px-4 py-3 text-right">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-list">
                                        <!-- Data will be populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </main>

                <!-- 頁尾 (導航欄) -->
                <footer id="main-footer" class="bg-white border-t border-gray-200 flex justify-around items-center">
                    <!-- 導航按鈕會根據權限動態生成 -->
                </footer>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="community-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="community-modal-title">新增社區</h3>
                <div class="mt-2 px-7 py-3">
                    <form id="community-form" onsubmit="return false;" class="space-y-4">
                        <input type="hidden" id="community-id-input">
                        <div>
                            <label for="community-code" class="text-left block text-sm font-medium text-gray-700">社區編號</label>
                            <input type="text" id="community-code" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div>
                            <label for="community-name" class="text-left block text-sm font-medium text-gray-700">社區名稱</label>
                            <input type="text" id="community-name" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div>
                            <label for="community-gps" class="text-left block text-sm font-medium text-gray-700">定位社區GPS</label>
                             <div class="flex items-center space-x-2 mt-1">
                                <input type="text" id="community-gps" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="點擊右側按鈕在地圖上選點">
                                <button type="button" class="get-gps-btn p-2 bg-blue-500 text-white rounded-md hover:bg-blue-600" data-target="community-gps">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="items-center px-4 py-3 text-center">
                    <button id="save-community-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">儲存</button>
                    <button id="close-community-modal-btn" class="ml-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">取消</button>
                </div>
            </div>
        </div>
    </div>

    <div id="user-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="user-modal-title">新增帳號</h3>
                <div class="mt-2 px-7 py-3">
                    <form id="user-form" onsubmit="return false;">
                        <input type="hidden" id="user-id-input">
                         <div class="mb-4">
                            <label for="user-role" class="text-left block text-sm font-medium text-gray-700">角色</label>
                            <select id="user-role" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="user-name" class="text-left block text-sm font-medium text-gray-700">姓名</label>
                            <input type="text" id="user-name" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div id="user-community-container" class="mb-4 hidden">
                            <label for="user-community" class="text-left block text-sm font-medium text-gray-700">所屬社區</label>
                            <select id="user-community" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500"></select>
                            <p class="text-xs text-left text-gray-500 mt-1">為「總幹事」角色指定一個管理的社區。</p>
                        </div>
                        <div class="mb-4">
                            <label for="user-email" class="text-left block text-sm font-medium text-gray-700">電子郵件 (帳號)</label>
                            <input type="email" id="user-email" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div id="password-container" class="mb-4">
                            <label for="user-password" class="text-left block text-sm font-medium text-gray-700">密碼</label>
                            <input type="text" id="user-password" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                            <p id="password-help-text" class="text-xs text-left text-gray-500 mt-1">新增帳號時為必填 (至少6個字元)。</p>
                        </div>
                    </form>
                </div>
                <div class="items-center px-4 py-3 text-center">
                    <button id="save-user-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">儲存</button>
                    <button id="close-user-modal-btn" class="ml-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">取消</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="schedule-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="schedule-modal-title">新增排程</h3>
                 <div class="mt-2 px-7 py-3 space-y-4">
                     <form id="schedule-form" onsubmit="return false;" class="space-y-4">
                         <input type="hidden" id="schedule-id-input">
                          <div>
                             <label for="schedule-community" class="text-left block text-sm font-medium text-gray-700">社區名稱</label>
                             <select id="schedule-community" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required></select>
                         </div>
                         <div>
                            <label for="schedule-patrol-code" class="text-left block text-sm font-medium text-gray-700">巡邏編號</label>
                            <input type="text" id="schedule-patrol-code" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div>
                            <label for="schedule-user" class="text-left block text-sm font-medium text-gray-700">人員 (保全/總幹事)</label>
                            <select id="schedule-user" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required></select>
                        </div>
                        <div>
                            <label class="text-left block text-sm font-medium text-gray-700">每日巡邏時間</label>
                            <div id="weekly-times-container" class="mt-2 space-y-2 p-3 bg-gray-50 rounded-md border">
                                <!-- Daily time inputs will be generated here -->
                            </div>
                        </div>
                     </form>
                 </div>
                 <div class="items-center px-4 py-3 text-center">
                    <button id="save-schedule-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">儲存</button>
                    <button id="close-schedule-modal-btn" class="ml-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">取消</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="patrol-points-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-5 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                 <h3 class="text-lg leading-6 font-medium text-gray-900" id="patrol-points-modal-title">管理巡邏點</h3>
                 <p id="patrol-points-schedule-info" class="text-sm text-gray-500 mb-4"></p>

                <!-- Add/Edit Patrol Point Form -->
                 <form id="patrol-point-form" onsubmit="return false;" class="p-4 border rounded-md bg-gray-50 space-y-4 mb-4">
                     <h4 class="font-semibold" id="patrol-point-form-title">新增巡邏點</h4>
                     <input type="hidden" id="patrol-point-internal-id">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="patrol-point-code" placeholder="巡邏點編號" class="px-3 py-2 border border-gray-300 rounded-md" required>
                         <div class="flex items-center space-x-2">
                            <input type="text" id="patrol-point-location" placeholder="定位位置" class="flex-grow px-3 py-2 border border-gray-300 rounded-md" required>
                            <button type="button" class="get-gps-btn p-2 bg-blue-500 text-white rounded-md hover:bg-blue-600" data-target="patrol-point-location">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                            </button>
                         </div>
                     </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <input type="text" id="patrol-point-name" placeholder="巡邏點名稱" class="px-3 py-2 border border-gray-300 rounded-md" required>
                         <div class="flex items-center space-x-2">
                            <input type="text" id="patrol-point-nfc-code" placeholder="NFC Code (16碼)" class="flex-grow px-3 py-2 border border-gray-300 rounded-md bg-gray-200" readonly>
                            <button id="generate-nfc-code-btn" type="button" class="px-3 py-2 bg-blue-500 text-white rounded-md text-sm">產生</button>
                         </div>
                     </div>
                     <div>
                         <button id="save-patrol-point-btn" type="submit" class="px-4 py-2 bg-red-500 text-white rounded-md">儲存巡邏點</button>
                         <button id="cancel-edit-point-btn" type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hidden">取消編輯</button>
                     </div>
                 </form>

                <!-- List of Patrol Points -->
                <div class="table-container max-h-64 overflow-y-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2">編號</th>
                                <th class="px-4 py-2">名稱</th>
                                <th class="px-4 py-2">位置</th>
                                <th class="px-4 py-2">NFC Code</th>
                                <th class="px-4 py-2 text-right">操作</th>
                            </tr>
                        </thead>
                        <tbody id="patrol-points-list">
                            <!-- Points will be populated by JS -->
                        </tbody>
                    </table>
                </div>

                 <div class="items-center px-4 py-3 text-right">
                    <button id="close-patrol-points-modal-btn" class="px-4 py-2 bg-gray-800 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-700">完成</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="map-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white">
             <h3 class="text-lg leading-6 font-medium text-gray-900">在地圖上選擇位置</h3>
             <p class="text-sm text-gray-500 mb-4">拖動圖釘以確定精確位置</p>
             <div id="map-container" class="rounded-md z-0"></div>
             <div class="items-center px-4 py-3 text-center">
                <button id="confirm-map-selection-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">確定位置</button>
                <button id="close-map-modal-btn" class="ml-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">取消</button>
            </div>
        </div>
    </div>

    <div id="log-details-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div id="print-area" class="relative top-5 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                 <div id="print-header" class="hidden">
                    <h1 class="text-2xl font-bold">巡邏紀錄報告</h1>
                    <p class="text-sm text-gray-600" id="print-date"></p>
                 </div>
                 <h3 class="text-lg leading-6 font-medium text-gray-900" id="log-details-modal-title">巡邏點紀錄</h3>
                 <div class="mt-4 table-container">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="px-4 py-2">社區</th>
                                <th class="px-4 py-2">保全</th>
                                <th class="px-4 py-2">巡邏點編號</th>
                                <th class="px-4 py-2">定位地圖</th>
                                <th class="px-4 py-2">感應時間</th>
                                <th class="px-4 py-2">狀態</th>
                                <th class="px-4 py-2 text-right print-hide" id="log-actions-header">操作</th>
                            </tr>
                        </thead>
                        <tbody id="log-details-list">
                            <!-- Log details will be populated by JS -->
                        </tbody>
                    </table>
                 </div>
                 <div class="items-center px-4 py-3 text-right print-hide">
                    <button id="print-log-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-blue-600">列印/匯出PDF</button>
                    <button id="close-log-details-modal-btn" class="px-4 py-2 bg-gray-800 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-700">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <div id="map-preview-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white">
             <h3 class="text-lg leading-6 font-medium text-gray-900">地圖預覽</h3>
             <p class="text-sm text-gray-500 mb-4">藍色圖釘為預設巡邏點，紅色為實際感應位置。</p>
             <div id="map-preview-container" class="rounded-md z-0 h-96 w-full"></div>
             <div class="items-center px-4 py-3 text-right">
                <button id="close-map-preview-modal-btn" class="px-4 py-2 bg-gray-800 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-700">關閉</button>
            </div>
        </div>
    </div>

    <div id="manual-log-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="manual-log-modal-title">手動紀錄</h3>
            <form id="manual-log-form" onsubmit="return false;" class="mt-4 space-y-4">
                <input type="hidden" id="manual-log-id">
                <input type="hidden" id="manual-log-schedule-id">
                <input type="hidden" id="manual-log-point-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700">巡邏點</label>
                    <p id="manual-log-point-name" class="mt-1 text-gray-800 font-semibold"></p>
                </div>
                <div>
                    <label for="manual-log-datetime" class="block text-sm font-medium text-gray-700">感應日期時間</label>
                    <input type="datetime-local" id="manual-log-datetime" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label for="manual-log-location" class="block text-sm font-medium text-gray-700">感應位置 (GPS)</label>
                    <div class="flex items-center space-x-2 mt-1">
                        <input type="text" id="manual-log-location" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        <button type="button" class="get-gps-btn p-2 bg-blue-500 text-white rounded-md" data-target="manual-log-location">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                        </button>
                    </div>
                </div>
                 <div class="items-center pt-4 text-center">
                    <button id="save-manual-log-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md">儲存紀錄</button>
                    <button id="close-manual-log-modal-btn" class="ml-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md">取消</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // 匯入 Firebase 模組
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, query, updateDoc, deleteDoc, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase 設定 ---
        const firebaseConfig = {
            apiKey: "AIzaSyBaBL7rKPnqpz8hbfILWq6cDWdZust13xM",
            authDomain: "nw-patrol.firebaseapp.com",
            projectId: "nw-patrol",
            storageBucket: "nw-patrol.appspot.com",
            messagingSenderId: "157808049159",
            appId: "1:157808049159:web:6f9128d16cb9919d50bea2",
            measurementId: "G-44B5L4KH1Q"
        };
        
        // --- 應用程式初始化 ---
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            document.getElementById('firebase-status').textContent = '已連接';
            document.getElementById('firebase-status').className = 'text-green-600';
        } catch(e) {
            console.error("Firebase 初始化失敗:", e);
            document.getElementById('firebase-status').textContent = '連接失敗';
            document.getElementById('firebase-status').className = 'text-red-600';
            alert("Firebase 初始化失敗，請檢查您的設定。");
        }


        // --- 變數與 DOM 元素 ---
        const loginPage = document.getElementById('login-page');
        const mainPage = document.getElementById('main-page');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const welcomeButton = document.getElementById('welcome-button');
        const logoutPopup = document.getElementById('logout-popup');
        const mainFooter = document.getElementById('main-footer');
        const nfcLog = document.getElementById('nfc-log');
        const nfcStatus = document.getElementById('nfc-status');
        const passwordInput = document.getElementById('password');
        const togglePasswordBtn = document.getElementById('toggle-password');
        const eyeIcon = document.getElementById('eye-icon');
        const eyeOffIcon = document.getElementById('eye-off-icon');
        const rememberMeCheckbox = document.getElementById('remember-me');
        const emailInput = document.getElementById('email');
        
        // Settings page elements
        const communitiesList = document.getElementById('communities-list');
        const usersList = document.getElementById('users-list');
        const communityModal = document.getElementById('community-modal');
        const userModal = document.getElementById('user-modal');

        // Schedule page elements
        const scheduleModal = document.getElementById('schedule-modal');
        const patrolPointsModal = document.getElementById('patrol-points-modal');
        const schedulesList = document.getElementById('schedules-list');

        // Patrol page elements
        const todaysPatrolsList = document.getElementById('todays-patrols-list');
        const nfcScanArea = document.getElementById('nfc-scan-area');

        // Data page elements
        const dataLogsContainer = document.getElementById('data-logs-container');
        const logDetailsModal = document.getElementById('log-details-modal');
        const manualLogModal = document.getElementById('manual-log-modal');
        
        // Map elements
        const mapModal = document.getElementById('map-modal');
        const mapPreviewModal = document.getElementById('map-preview-modal');


        let currentUser = null;
        let userProfile = null;
        let communitiesUnsubscribe = null;
        let usersUnsubscribe = null;
        let schedulesUnsubscribe = null;
        let editingCommunityId = null;
        let editingUserId = null;
        let editingScheduleId = null;
        let currentScheduleForPoints = null; // Holds the full schedule object being edited for points
        let activePatrol = null; // Holds schedule data for the currently active patrol scan
        
        let map = null;
        let marker = null;
        let currentGpsTargetInput = null;

        let mapPreview = null;
        let pointMarker = null;
        let scanMarker = null;
        let locationCircle = null;


        // --- 權限設定 ---
        const ROLES = {
            ADMIN: '管理員',
            EXECUTIVE: '高階主管',
            CHIEF: '總幹事',
            GUARD: '保全'
        };

        const PAGE_PERMISSIONS = {
            'home': [ROLES.ADMIN, ROLES.EXECUTIVE, ROLES.CHIEF, ROLES.GUARD],
            'patrol': [ROLES.ADMIN, ROLES.EXECUTIVE, ROLES.CHIEF, ROLES.GUARD],
            'data': [ROLES.ADMIN, ROLES.EXECUTIVE, ROLES.CHIEF, ROLES.GUARD],
            'schedule': [ROLES.ADMIN, ROLES.EXECUTIVE, ROLES.CHIEF],
            'settings': [ROLES.ADMIN]
        };
        
        const NAV_ITEMS = [
            { id: 'home', label: '首頁', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>` },
            { id: 'patrol', label: '巡邏', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg>` },
            { id: 'data', label: '資料', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>` },
            { id: 'schedule', label: '排程', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>` },
            { id: 'settings', label: '設定', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>` },
        ];


        // --- 認證流程 ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userProfileRef = doc(db, "users", user.uid);
                const userProfileSnap = await getDoc(userProfileRef);

                if (userProfileSnap.exists()) {
                    userProfile = userProfileSnap.data();
                    
                    welcomeButton.textContent = `歡迎~${userProfile.name}`;
                    loginPage.classList.add('hidden');
                    mainPage.classList.remove('hidden');
                    renderNavigation();
                    navigateTo('home');
                } else {
                    console.error("找不到使用者設定檔:", user.uid);
                    loginError.textContent = "無法載入使用者資料，請聯繫管理員。";
                    await signOut(auth);
                }
            } else {
                currentUser = null;
                userProfile = null;
                loginPage.classList.remove('hidden');
                mainPage.classList.add('hidden');
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            loginError.textContent = '';
            if (rememberMeCheckbox.checked) {
                localStorage.setItem('rememberedEmail', email);
            } else {
                localStorage.removeItem('rememberedEmail');
            }
            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    console.error("登入失敗:", error);
                    loginError.textContent = '帳號或密碼錯誤。';
                });
        });

        welcomeButton.addEventListener('click', () => {
            logoutPopup.classList.toggle('hidden');
        });

        document.getElementById('confirm-logout-btn').addEventListener('click', () => {
             signOut(auth);
             logoutPopup.classList.add('hidden');
        });
        
        document.getElementById('cancel-logout-btn').addEventListener('click', () => {
             logoutPopup.classList.add('hidden');
        });

        
        // --- 導航與頁面渲染 ---
        function renderNavigation() {
            mainFooter.innerHTML = '';
            NAV_ITEMS.forEach(item => {
                if (PAGE_PERMISSIONS[item.id] && PAGE_PERMISSIONS[item.id].includes(userProfile.role)) {
                    const btn = document.createElement('button');
                    btn.className = 'nav-btn flex flex-col items-center justify-center w-full h-full text-gray-500 hover:bg-gray-100 transition p-2 rounded-lg';
                    btn.dataset.page = item.id;
                    btn.innerHTML = `${item.icon}<span class="text-xs mt-1">${item.label}</span>`;
                    btn.addEventListener('click', () => navigateTo(item.id));
                    mainFooter.appendChild(btn);
                }
            });
        }
        
        function navigateTo(pageId) {
            document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
            
            if (communitiesUnsubscribe) { communitiesUnsubscribe(); communitiesUnsubscribe = null; }
            if (usersUnsubscribe) { usersUnsubscribe(); usersUnsubscribe = null; }
            if (schedulesUnsubscribe) { schedulesUnsubscribe(); schedulesUnsubscribe = null; }
            nfcScanArea.classList.add('hidden'); // Hide scan area on any navigation
            
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            
            if (pageId === 'settings') {
                listenForCommunities();
                listenForUsers();
            } else if (pageId === 'schedule') {
                populateScheduleFilters();
                listenForSchedules();
            } else if (pageId === 'patrol') {
                renderTodaysPatrols();
            } else if (pageId === 'data') {
                loadAndRenderDataPage();
            }
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.page === pageId);
            });
        }
        
        // --- 設定頁面 CRUD ---
        
        // Modal helpers
        function openModal(modal) { modal.classList.remove('hidden'); }
        function closeModal(modal) { modal.classList.add('hidden'); }
        
        // Community Management
        function listenForCommunities() {
            const q = query(collection(db, "communities"));
            communitiesUnsubscribe = onSnapshot(q, (querySnapshot) => {
                const communities = [];
                querySnapshot.forEach((doc) => communities.push({ id: doc.id, ...doc.data() }));
                renderCommunities(communities);
            });
        }

        function renderCommunities(communities) {
            communitiesList.innerHTML = '';
            if (communities.length === 0) {
                communitiesList.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">尚無社區資料</td></tr>`;
                return;
            }
            communities.forEach(c => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium text-gray-900 whitespace-nowrap">${c.code}</td>
                    <td class="px-4 py-3">${c.name}</td>
                    <td class="px-4 py-3 text-xs">${c.gps || '未設定'}</td>
                    <td class="px-4 py-3 text-right">
                        <button class="edit-community-btn font-medium text-blue-600 hover:underline mr-2" data-id="${c.id}">編輯</button>
                        <button class="delete-community-btn font-medium text-red-600 hover:underline" data-id="${c.id}">刪除</button>
                    </td>`;
                communitiesList.appendChild(row);
            });
        }

        async function saveCommunity() {
            const code = document.getElementById('community-code').value;
            const name = document.getElementById('community-name').value;
            const gps = document.getElementById('community-gps').value;
            if (!code || !name) { alert("請填寫所有欄位"); return; }
            
            const data = { code, name, gps };
            try {
                if (editingCommunityId) {
                    await updateDoc(doc(db, "communities", editingCommunityId), data);
                } else {
                    await addDoc(collection(db, "communities"), data);
                }
                closeModal(communityModal);
            } catch (e) {
                console.error("儲存社區失敗: ", e);
                alert("儲存失敗");
            }
        }
        
        // User Management
        function listenForUsers() {
            const q = query(collection(db, "users"));
            usersUnsubscribe = onSnapshot(q, (querySnapshot) => {
                const users = [];
                querySnapshot.forEach((doc) => users.push({ id: doc.id, ...doc.data() }));
                renderUsers(users);
            });
        }
        
        function renderUsers(users) {
            usersList.innerHTML = '';
            if (users.length === 0) {
                 usersList.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">尚無帳號資料</td></tr>`;
                 return;
            }
            users.forEach(u => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                row.innerHTML = `
                    <td class="px-4 py-3">${u.role}</td>
                    <td class="px-4 py-3 font-medium text-gray-900 whitespace-nowrap">${u.name}</td>
                    <td class="px-4 py-3">${u.email}</td>
                    <td class="px-4 py-3 text-right">
                        <button class="edit-user-btn font-medium text-blue-600 hover:underline mr-2" data-id="${u.id}">編輯</button>
                        <button class="delete-user-btn font-medium text-red-600 hover:underline" data-id="${u.id}">刪除</button>
                    </td>`;
                usersList.appendChild(row);
            });
        }

        async function saveUser() {
            const role = document.getElementById('user-role').value;
            const name = document.getElementById('user-name').value;
            const email = document.getElementById('user-email').value;
            const password = document.getElementById('user-password').value;
            if (!role || !name || !email) { 
                alert("角色、姓名和電子郵件為必填項"); 
                return; 
            }

            const data = { role, name, email };
            if (role === ROLES.CHIEF) {
                const communityId = document.getElementById('user-community').value;
                if (!communityId) {
                    alert('請為總幹事選擇一個所屬社區。');
                    return;
                }
                data.communityId = communityId;
            }

            if (editingUserId) {
                // Editing an existing user
                try {
                    await updateDoc(doc(db, "users", editingUserId), data);
                    closeModal(userModal);
                } catch (e) {
                     console.error("更新使用者失敗: ", e);
                     alert("更新失敗: " + e.message);
                }
            } else {
                // Creating a new user
                if (!password || password.length < 6) {
                    alert("新增使用者時必須設定密碼 (至少6個字元)。");
                    return;
                }

                // Use a temporary app instance to create the user without logging out the admin
                const tempAppName = 'userCreationApp_' + Date.now();
                const tempApp = initializeApp(firebaseConfig, tempAppName);
                const tempAuth = getAuth(tempApp);

                try {
                    // 1. Create user in Firebase Auth using the temporary instance
                    const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
                    const user = userCredential.user;

                    // 2. Create user profile in our main Firestore with the new user's UID
                    await setDoc(doc(db, "users", user.uid), data);

                    closeModal(userModal); // Success
                } catch (e) {
                    console.error("創建使用者失敗: ", e);
                    if (e.code === 'auth/email-already-in-use') {
                        alert("此電子郵件已被註冊。");
                    } else if (e.code === 'auth/weak-password') {
                        alert("密碼太弱，至少需要6個字元。");
                    } else {
                        alert("操作失敗: " + e.message);
                    }
                } finally {
                    // 3. Clean up the temporary app instance
                    await deleteApp(tempApp);
                }
            }
        }

        // --- 排程頁面 CRUD ---
        async function getOptionsForSelect(collectionName, textField) {
            const q = query(collection(db, collectionName));
            const snapshot = await getDocs(q);
            const options = [];
            snapshot.forEach(docSnap => {
                options.push({ id: docSnap.id, text: docSnap.data()[textField] });
            });
            return options;
        }

        async function getPatrolStaffForSelect() {
            const q = query(collection(db, "users"), where("role", "in", [ROLES.GUARD, ROLES.CHIEF]));
            const snapshot = await getDocs(q);
            const options = [];
            snapshot.forEach(docSnap => {
                options.push({ id: docSnap.id, text: `${docSnap.data().name} (${docSnap.data().role})` });
            });
            return options;
        }
        
        function populateSelect(selectElement, options, defaultOptionText = '全部') {
             selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
             options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.id;
                option.dataset.name = opt.text;
                option.textContent = opt.text;
                selectElement.appendChild(option);
             });
        }


        async function populateScheduleFilters() {
            const [communities, staff] = await Promise.all([
                getOptionsForSelect('communities', 'name'),
                getPatrolStaffForSelect()
            ]);
            populateSelect(document.getElementById('filter-community'), communities);
            populateSelect(document.getElementById('filter-user'), staff);
        }

        function listenForSchedules() {
            if (schedulesUnsubscribe) schedulesUnsubscribe();
            
            const communityFilter = document.getElementById('filter-community').value;
            const userFilter = document.getElementById('filter-user').value;

            let constraints = [];
            if (communityFilter) constraints.push(where("communityId", "==", communityFilter));
            if (userFilter) constraints.push(where("userId", "==", userFilter));
            
            const q = query(collection(db, "schedules"), ...constraints);
            schedulesUnsubscribe = onSnapshot(q, (querySnapshot) => {
                const schedules = [];
                querySnapshot.forEach((doc) => schedules.push({ id: doc.id, ...doc.data() }));
                renderSchedules(schedules);
            });
        }
        
        function formatWeeklyTimes(weeklyTimes) {
            if (!weeklyTimes || Object.keys(weeklyTimes).length === 0) {
                return '未設定';
            }
            const days = ['日', '一', '二', '三', '四', '五', '六'];
            return Object.entries(weeklyTimes)
                .map(([dayIndex, time]) => `週${days[dayIndex]} ${time}`)
                .join(', ');
        }


        function renderSchedules(schedules) {
             schedulesList.innerHTML = '';
             if(schedules.length === 0) {
                schedulesList.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">無符合條件的排程</td></tr>`;
                return;
             }
             schedules.forEach(s => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                const patrolPointsCount = s.patrolPoints ? s.patrolPoints.length : 0;
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium text-gray-900">${s.communityName}</td>
                    <td class="px-4 py-3">${s.patrolCode}</td>
                    <td class="px-4 py-3">
                        <button class="manage-points-btn text-blue-600 hover:underline" data-id="${s.id}">${patrolPointsCount} 個</button>
                    </td>
                    <td class="px-4 py-3 text-xs">${formatWeeklyTimes(s.weeklyTimes)}</td>
                    <td class="px-4 py-3">${s.userName}</td>
                    <td class="px-4 py-3 text-right">
                        <button class="copy-schedule-btn font-medium text-green-600 hover:underline mr-2" data-id="${s.id}">複製</button>
                        <button class="edit-schedule-btn font-medium text-blue-600 hover:underline mr-2" data-id="${s.id}">編輯</button>
                        <button class="delete-schedule-btn font-medium text-red-600 hover:underline" data-id="${s.id}">刪除</button>
                    </td>
                `;
                 schedulesList.appendChild(row);
             });
        }
        
        async function saveSchedule() {
            const communitySelect = document.getElementById('schedule-community');
            const communityId = communitySelect.value;
            const communityName = communitySelect.options[communitySelect.selectedIndex].dataset.name;
            
            const userSelect = document.getElementById('schedule-user');
            const userId = userSelect.value;
            const userName = userSelect.options[userSelect.selectedIndex].dataset.name;

            const patrolCode = document.getElementById('schedule-patrol-code').value;
            
            const weeklyTimes = {};
            const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            days.forEach((day, index) => {
                const checkbox = document.getElementById(`schedule-day-${index}`);
                if (checkbox.checked) {
                    const timeInput = document.getElementById(`schedule-time-${index}`);
                    if(timeInput.value) {
                       weeklyTimes[index] = timeInput.value;
                    }
                }
            });

            if (!communityId || !patrolCode || !userId || Object.keys(weeklyTimes).length === 0) {
                alert("請填寫社區、巡邏編號、人員並至少設定一個巡邏時間。");
                return;
            }

            const data = { communityId, communityName, patrolCode, weeklyTimes, userId, userName };

            try {
                 if (editingScheduleId) {
                    const existingDoc = await getDoc(doc(db, "schedules", editingScheduleId));
                    data.patrolPoints = existingDoc.data().patrolPoints || [];
                    await setDoc(doc(db, "schedules", editingScheduleId), data);
                } else {
                    data.patrolPoints = currentScheduleForPoints ? currentScheduleForPoints.patrolPoints : []; 
                    await addDoc(collection(db, "schedules"), data);
                }
                closeModal(scheduleModal);
            } catch (e) {
                console.error("儲存排程失敗: ", e);
                alert("儲存失敗");
            }
        }
        
        function renderPatrolPoints(schedule) {
            const listEl = document.getElementById('patrol-points-list');
            listEl.innerHTML = '';
            document.getElementById('patrol-points-modal-title').textContent = `管理巡邏點`;
            document.getElementById('patrol-points-schedule-info').textContent = `社區: ${schedule.communityName} | 巡邏編號: ${schedule.patrolCode}`;
            
            if (!schedule.patrolPoints || schedule.patrolPoints.length === 0) {
                listEl.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">尚無巡邏點</td></tr>`;
                return;
            }
            schedule.patrolPoints.forEach(p => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                row.innerHTML = `
                    <td class="px-4 py-2">${p.code}</td>
                    <td class="px-4 py-2">${p.name}</td>
                    <td class="px-4 py-2 text-xs">${p.location}</td>
                    <td class="px-4 py-2 font-mono text-xs">${p.nfcCode}</td>
                    <td class="px-4 py-2 text-right">
                        <button class="edit-point-btn font-medium text-blue-600 hover:underline mr-2" data-id="${p.internalId}">編輯</button>
                        <button class="delete-point-btn font-medium text-red-600 hover:underline" data-id="${p.internalId}">刪除</button>
                    </td>
                `;
                listEl.appendChild(row);
            });
        }
        
        async function savePatrolPoint() {
            const form = document.getElementById('patrol-point-form');
            const internalId = form.querySelector('#patrol-point-internal-id').value;
            
            const newPoint = {
                internalId: internalId || crypto.randomUUID(),
                code: form.querySelector('#patrol-point-code').value,
                location: form.querySelector('#patrol-point-location').value,
                name: form.querySelector('#patrol-point-name').value,
                nfcCode: form.querySelector('#patrol-point-nfc-code').value,
            };

            if (!newPoint.code || !newPoint.location || !newPoint.name || !newPoint.nfcCode) {
                alert('請填寫巡邏點的所有欄位');
                return;
            }

            const scheduleRef = doc(db, 'schedules', currentScheduleForPoints.id);
            let updatedPoints = [...(currentScheduleForPoints.patrolPoints || [])];

            const existingPointIndex = updatedPoints.findIndex(p => p.internalId === newPoint.internalId);
            if (existingPointIndex > -1) {
                updatedPoints[existingPointIndex] = newPoint; // Update
            } else {
                updatedPoints.push(newPoint); // Add
            }

            try {
                await updateDoc(scheduleRef, { patrolPoints: updatedPoints });
                const updatedScheduleSnap = await getDoc(scheduleRef);
                currentScheduleForPoints = { id: updatedScheduleSnap.id, ...updatedScheduleSnap.data() };
                renderPatrolPoints(currentScheduleForPoints);
                form.reset();
                document.getElementById('patrol-point-form-title').textContent = '新增巡邏點';
                document.getElementById('cancel-edit-point-btn').classList.add('hidden');
            } catch (error) {
                console.error('儲存巡邏點失敗:', error);
                alert('儲存巡邏點失敗');
            }
        }
        
        // --- 巡邏頁面 ---
        async function renderTodaysPatrols() {
            todaysPatrolsList.innerHTML = '<p class="text-gray-500">正在載入今日任務...</p>';
            if (!currentUser) return;

            const today = new Date().getDay(); // 0 for Sunday, 1 for Monday...
            const q = query(collection(db, "schedules"), where("userId", "==", currentUser.uid));
            const querySnapshot = await getDocs(q);
            
            const todaysTasks = [];
            querySnapshot.forEach(doc => {
                const schedule = { id: doc.id, ...doc.data() };
                if (schedule.weeklyTimes && schedule.weeklyTimes[today]) {
                    todaysTasks.push(schedule);
                }
            });

            if (todaysTasks.length === 0) {
                 todaysPatrolsList.innerHTML = '<p class="text-gray-500">今日無排定巡邏任務。</p>';
                 return;
            }

            todaysPatrolsList.innerHTML = '';
            todaysTasks.forEach(task => {
                const card = document.createElement('div');
                card.className = 'p-4 bg-white rounded-lg shadow border border-gray-200';
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold text-lg text-gray-800">${task.communityName}</p>
                            <p class="text-sm text-gray-500">${task.patrolCode}</p>
                        </div>
                        <div class="text-right">
                             <p class="font-semibold text-red-600">${task.weeklyTimes[today]}</p>
                             <button class="start-patrol-btn mt-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">開始巡邏</button>
                        </div>
                    </div>
                `;
                card.querySelector('.start-patrol-btn').addEventListener('click', () => {
                    activePatrol = task;
                    document.getElementById('nfc-scan-area-title').textContent = `${task.communityName} - ${task.patrolCode}`;
                    nfcScanArea.classList.remove('hidden');
                    nfcLog.innerHTML = '<p class="text-gray-400">掃描紀錄將顯示於此...</p>';
                    startNFCScan();
                });
                todaysPatrolsList.appendChild(card);
            });
        }
        
        // --- 資料頁面 ---
        async function loadAndRenderDataPage() {
            dataLogsContainer.innerHTML = '<p class="text-gray-500">正在載入今日紀錄...</p>';
            if (!userProfile) return;

            const today = new Date();
            const startOfDay = new Date(today.setHours(0, 0, 0, 0));
            const endOfDay = new Date(today.setHours(23, 59, 59, 999));
            const todayIndex = new Date().getDay();

            // 1. Get relevant schedules for today
            let schedulesQuery;
            switch(userProfile.role) {
                case ROLES.GUARD:
                    schedulesQuery = query(collection(db, "schedules"), where("userId", "==", currentUser.uid));
                    break;
                case ROLES.CHIEF:
                    // Assuming Chief's profile has a communityId field. This needs to be added to user profiles.
                    if (userProfile.communityId) {
                       schedulesQuery = query(collection(db, "schedules"), where("communityId", "==", userProfile.communityId));
                    } else {
                       dataLogsContainer.innerHTML = '<p class="text-red-500">錯誤：總幹事帳號未設定所屬社區。</p>';
                       return;
                    }
                    break;
                case ROLES.ADMIN:
                case ROLES.EXECUTIVE:
                    schedulesQuery = query(collection(db, "schedules"));
                    break;
                default:
                    dataLogsContainer.innerHTML = '';
                    return;
            }

            const schedulesSnapshot = await getDocs(schedulesQuery);
            const todaysSchedules = [];
            schedulesSnapshot.forEach(doc => {
                const schedule = { id: doc.id, ...doc.data() };
                if (schedule.weeklyTimes && schedule.weeklyTimes[todayIndex]) {
                    todaysSchedules.push(schedule);
                }
            });

            if (todaysSchedules.length === 0) {
                dataLogsContainer.innerHTML = '<p class="text-gray-500">今日無相關巡邏排程。</p>';
                return;
            }
            
            // 2. Get all logs for today
            const logsQuery = query(collection(db, "patrol_logs"), where("timestamp", ">=", Timestamp.fromDate(startOfDay)), where("timestamp", "<=", Timestamp.fromDate(endOfDay)));
            const logsSnapshot = await getDocs(logsQuery);
            const todaysLogs = [];
            logsSnapshot.forEach(doc => {
                todaysLogs.push({ id: doc.id, ...doc.data() });
            });

            // 3. Group logs by scheduleId
            const logsBySchedule = todaysLogs.reduce((acc, log) => {
                const scheduleId = log.scheduleId;
                if (!acc[scheduleId]) {
                    acc[scheduleId] = [];
                }
                acc[scheduleId].push(log);
                return acc;
            }, {});

            // 4. Render schedule blocks
            dataLogsContainer.innerHTML = '';
            todaysSchedules.forEach(schedule => {
                const logsForThisSchedule = logsBySchedule[schedule.id] || [];
                const totalPoints = schedule.patrolPoints?.length || 0;
                const completedPoints = new Set(logsForThisSchedule.map(l => l.patrolPointId)).size;

                const card = document.createElement('div');
                card.className = 'p-4 bg-white rounded-lg shadow border border-gray-200 cursor-pointer hover:bg-gray-50';
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold text-lg text-gray-800">${schedule.communityName}</p>
                            <p class="text-sm text-gray-500">${schedule.patrolCode} (${schedule.userName})</p>
                        </div>
                        <div class="text-right">
                             <p class="font-semibold text-lg">${completedPoints} / ${totalPoints}</p>
                             <p class="text-xs text-gray-500">已完成/總數</p>
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => {
                    renderLogDetailsModal(schedule, logsForThisSchedule);
                });
                dataLogsContainer.appendChild(card);
            });
        }

        function renderLogDetailsModal(schedule, logs) {
            const modalTitle = document.getElementById('log-details-modal-title');
            const detailsList = document.getElementById('log-details-list');
            const isAdmin = [ROLES.ADMIN, ROLES.EXECUTIVE].includes(userProfile.role);
            document.getElementById('log-actions-header').style.display = isAdmin ? 'table-cell' : 'none';
            
            modalTitle.textContent = `巡邏紀錄: ${schedule.communityName} - ${schedule.patrolCode}`;
            detailsList.innerHTML = '';

            const allPoints = schedule.patrolPoints || [];
            if (allPoints.length === 0) {
                 detailsList.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">此排程未設定任何巡邏點。</td></tr>';
                 openModal(logDetailsModal);
                 return;
            }
            
            allPoints.forEach(point => {
                const log = logs.find(l => l.patrolPointId === point.internalId);
                const row = document.createElement('tr');
                const isCompleted = !!log;
                
                let statusText = '異常';
                let statusColor = 'bg-red-200 text-red-800';
                let rowColor = 'bg-red-50';

                if (isCompleted) {
                    const distance = calculateDistance(point.location, log.scanLocation);
                    if (distance <= 20) {
                        statusText = '正常';
                        statusColor = 'bg-green-200 text-green-800';
                        rowColor = 'bg-green-50';
                    } else {
                        statusText = `異常 (距離 ${distance.toFixed(0)}公尺)`;
                    }
                }

                row.className = rowColor;
                
                const locationButton = `<button class="show-map-preview-btn text-blue-600 hover:underline" data-point-location="${point.location || ''}" data-scan-location="${log?.scanLocation || ''}">${point.location || 'N/A'}</button>`;
                
                let actionsHtml = '';
                if (isAdmin) {
                    if (isCompleted) {
                        actionsHtml = `
                            <button class="edit-log-btn text-blue-600 hover:underline text-xs" data-log-id="${log.id}">編輯</button>
                            <button class="delete-log-btn text-red-600 hover:underline text-xs ml-2" data-log-id="${log.id}">刪除</button>
                        `;
                    } else {
                        actionsHtml = `<button class="add-log-btn text-green-600 hover:underline text-xs" data-schedule-id="${schedule.id}" data-point-id="${point.internalId}">補登</button>`;
                    }
                }

                row.innerHTML = `
                    <td class="px-4 py-3">${schedule.communityName}</td>
                    <td class="px-4 py-3">${schedule.userName}</td>
                    <td class="px-4 py-3">${point.code} (${point.name})</td>
                    <td class="px-4 py-3 text-xs">${locationButton}</td>
                    <td class="px-4 py-3">${isCompleted ? log.timestamp.toDate().toLocaleTimeString() : '--'}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-right print-hide">${actionsHtml}</td>
                `;
                detailsList.appendChild(row);
            });

            openModal(logDetailsModal);
        }

        // --- Event Listeners for Page Actions ---
        document.addEventListener('click', async (e) => {
            // Community Modals & Actions
            if (e.target.id === 'add-community-btn') {
                editingCommunityId = null;
                document.getElementById('community-modal-title').textContent = '新增社區';
                document.getElementById('community-form').reset();
                openModal(communityModal);
            }
            if (e.target.id === 'close-community-modal-btn') closeModal(communityModal);
            if (e.target.id === 'save-community-btn') saveCommunity();
            if (e.target.classList.contains('edit-community-btn')) {
                editingCommunityId = e.target.dataset.id;
                const communityRef = doc(db, "communities", editingCommunityId);
                const communitySnap = await getDoc(communityRef);
                if (communitySnap.exists()) {
                    const data = communitySnap.data();
                    document.getElementById('community-modal-title').textContent = '編輯社區';
                    document.getElementById('community-code').value = data.code;
                    document.getElementById('community-name').value = data.name;
                    document.getElementById('community-gps').value = data.gps || '';
                    openModal(communityModal);
                }
            }
            if (e.target.classList.contains('delete-community-btn')) {
                if (confirm('確定要刪除此社區嗎？')) {
                    await deleteDoc(doc(db, "communities", e.target.dataset.id));
                }
            }

            // User Modals & Actions
            if (e.target.id === 'add-user-btn') {
                editingUserId = null;
                document.getElementById('user-modal-title').textContent = '新增帳號';
                document.getElementById('user-form').reset();
                document.getElementById('user-email').disabled = false;
                document.getElementById('password-container').classList.remove('hidden');
                document.getElementById('password-help-text').textContent = '新增帳號時為必填 (至少6個字元)。';
                populateSelect(document.getElementById('user-community'), await getOptionsForSelect('communities', 'name'), '選擇社區');
                document.getElementById('user-community-container').classList.add('hidden');
                openModal(userModal);
            }
            if (e.target.id === 'close-user-modal-btn') closeModal(userModal);
            if (e.target.id === 'save-user-btn') saveUser();
             if (e.target.classList.contains('edit-user-btn')) {
                editingUserId = e.target.dataset.id;
                const userRef = doc(db, "users", editingUserId);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    const data = userSnap.data();
                    document.getElementById('user-modal-title').textContent = '編輯帳號';
                    document.getElementById('user-role').value = data.role;
                    document.getElementById('user-name').value = data.name;
                    document.getElementById('user-email').value = data.email;
                    document.getElementById('user-email').disabled = true;
                    document.getElementById('password-container').classList.add('hidden');
                    document.getElementById('user-password').value = '';
                    
                    const communitySelect = document.getElementById('user-community');
                    await populateSelect(communitySelect, await getOptionsForSelect('communities', 'name'), '選擇社區');
                    if (data.role === ROLES.CHIEF) {
                        document.getElementById('user-community-container').classList.remove('hidden');
                        communitySelect.value = data.communityId || '';
                    } else {
                        document.getElementById('user-community-container').classList.add('hidden');
                    }
                    openModal(userModal);
                }
            }
            if (e.target.classList.contains('delete-user-btn')) {
                 if (confirm('確定要刪除此帳號嗎？(此操作僅刪除資料庫紀錄)')) {
                    await deleteDoc(doc(db, "users", e.target.dataset.id));
                }
            }
            
            // Schedule Modals & Actions
            if (e.target.id === 'add-schedule-btn' || e.target.classList.contains('copy-schedule-btn')) {
                const isCopy = e.target.classList.contains('copy-schedule-btn');
                let sourceData = null;

                if (isCopy) {
                    const scheduleId = e.target.dataset.id;
                    const scheduleSnap = await getDoc(doc(db, "schedules", scheduleId));
                    if(scheduleSnap.exists()) sourceData = scheduleSnap.data();
                    editingScheduleId = null; 
                    currentScheduleForPoints = sourceData; 
                    document.getElementById('schedule-modal-title').textContent = '複製排程';
                } else {
                    editingScheduleId = null;
                    currentScheduleForPoints = null; 
                    document.getElementById('schedule-modal-title').textContent = '新增排程';
                }
                
                document.getElementById('schedule-form').reset();
                 document.querySelectorAll('#weekly-times-container input[type="checkbox"]').forEach((cb, index) => {
                    cb.checked = false;
                    const timeInput = document.getElementById(`schedule-time-${index}`);
                    timeInput.disabled = true;
                    timeInput.value = '';
                 });

                
                const [communities, staff] = await Promise.all([
                    getOptionsForSelect('communities', 'name'),
                    getPatrolStaffForSelect()
                ]);
                populateSelect(document.getElementById('schedule-community'), communities, '選擇社區');
                populateSelect(document.getElementById('schedule-user'), staff, '選擇人員');

                if (sourceData) {
                    document.getElementById('schedule-community').value = sourceData.communityId || '';
                    document.getElementById('schedule-user').value = sourceData.userId || '';
                    document.getElementById('schedule-patrol-code').value = `${sourceData.patrolCode}-副本`;
                    if (sourceData.weeklyTimes) {
                         Object.entries(sourceData.weeklyTimes).forEach(([dayIndex, time]) => {
                             const checkbox = document.getElementById(`schedule-day-${dayIndex}`);
                             const timeInput = document.getElementById(`schedule-time-${dayIndex}`);
                             if (checkbox && timeInput) {
                                checkbox.checked = true;
                                timeInput.value = time;
                                timeInput.disabled = false;
                             }
                         });
                    }
                }
                
                openModal(scheduleModal);
            }
            if (e.target.id === 'close-schedule-modal-btn') closeModal(scheduleModal);
            if (e.target.id === 'save-schedule-btn') saveSchedule();
            if (e.target.classList.contains('edit-schedule-btn')) {
                 editingScheduleId = e.target.dataset.id;
                 const scheduleRef = doc(db, "schedules", editingScheduleId);
                 const scheduleSnap = await getDoc(scheduleRef);
                 if (scheduleSnap.exists()) {
                     const data = scheduleSnap.data();
                     document.getElementById('schedule-modal-title').textContent = '編輯排程';
                     
                     const [communities, staff] = await Promise.all([
                        getOptionsForSelect('communities', 'name'),
                        getPatrolStaffForSelect()
                     ]);
                     populateSelect(document.getElementById('schedule-community'), communities, '選擇社區');
                     populateSelect(document.getElementById('schedule-user'), staff, '選擇人員');

                     document.getElementById('schedule-community').value = data.communityId;
                     document.getElementById('schedule-user').value = data.userId;
                     document.getElementById('schedule-patrol-code').value = data.patrolCode;
                     
                     document.querySelectorAll('#weekly-times-container input[type="checkbox"]').forEach((cb, index) => {
                        cb.checked = false;
                        const timeInput = document.getElementById(`schedule-time-${index}`);
                        timeInput.disabled = true;
                        timeInput.value = '';
                     });
                     
                     if (data.weeklyTimes) {
                         Object.entries(data.weeklyTimes).forEach(([dayIndex, time]) => {
                             const checkbox = document.getElementById(`schedule-day-${dayIndex}`);
                             const timeInput = document.getElementById(`schedule-time-${dayIndex}`);
                             if (checkbox && timeInput) {
                                checkbox.checked = true;
                                timeInput.value = time;
                                timeInput.disabled = false;
                             }
                         });
                     }
                     openModal(scheduleModal);
                 }
            }
            if (e.target.classList.contains('delete-schedule-btn')) {
                if(confirm('確定要刪除此排程嗎？')) {
                    await deleteDoc(doc(db, "schedules", e.target.dataset.id));
                }
            }

            // Patrol Points Modal
            if(e.target.classList.contains('manage-points-btn')) {
                const scheduleId = e.target.dataset.id;
                const scheduleRef = doc(db, 'schedules', scheduleId);
                const scheduleSnap = await getDoc(scheduleRef);
                if (scheduleSnap.exists()) {
                    currentScheduleForPoints = { id: scheduleSnap.id, ...scheduleSnap.data() };
                    renderPatrolPoints(currentScheduleForPoints);
                    openModal(patrolPointsModal);
                }
            }
            if(e.target.id === 'close-patrol-points-modal-btn') closeModal(patrolPointsModal);
            if(e.target.id === 'save-patrol-point-btn') savePatrolPoint();
            if(e.target.id === 'generate-nfc-code-btn') {
                document.getElementById('patrol-point-nfc-code').value = generateAlphanumericCode(16);
            }
            if (e.target.classList.contains('edit-point-btn')) {
                const pointId = e.target.dataset.id;
                const point = currentScheduleForPoints.patrolPoints.find(p => p.internalId === pointId);
                if (point) {
                    const form = document.getElementById('patrol-point-form');
                    form.querySelector('#patrol-point-internal-id').value = point.internalId;
                    form.querySelector('#patrol-point-code').value = point.code;
                    form.querySelector('#patrol-point-location').value = point.location;
                    form.querySelector('#patrol-point-name').value = point.name;
                    form.querySelector('#patrol-point-nfc-code').value = point.nfcCode;
                    document.getElementById('patrol-point-form-title').textContent = '編輯巡邏點';
                    document.getElementById('cancel-edit-point-btn').classList.remove('hidden');
                }
            }
            if (e.target.id === 'cancel-edit-point-btn') {
                document.getElementById('patrol-point-form').reset();
                document.getElementById('patrol-point-form-title').textContent = '新增巡邏點';
                e.target.classList.add('hidden');
            }
            if(e.target.classList.contains('delete-point-btn')) {
                if(confirm('確定要刪除此巡邏點嗎？')) {
                    const pointIdToDelete = e.target.dataset.id;
                    const updatedPoints = currentScheduleForPoints.patrolPoints.filter(p => p.internalId !== pointIdToDelete);
                    const scheduleRef = doc(db, 'schedules', currentScheduleForPoints.id);
                    await updateDoc(scheduleRef, { patrolPoints: updatedPoints });
                    currentScheduleForPoints.patrolPoints = updatedPoints;
                    renderPatrolPoints(currentScheduleForPoints);
                }
            }
            
            // GPS Buttons
            if (e.target.closest('.get-gps-btn')) {
                const targetId = e.target.closest('.get-gps-btn').dataset.target;
                initializeMapForSelection(targetId);
            }

            // Log Details Modal & Manual Log Modal
            if (e.target.id === 'close-log-details-modal-btn') closeModal(logDetailsModal);
            if (e.target.id === 'close-manual-log-modal-btn') closeModal(manualLogModal);
            if (e.target.id === 'save-manual-log-btn') await saveManualLog();
            if (e.target.classList.contains('show-map-preview-btn')) {
                const pointLoc = e.target.dataset.pointLocation;
                const scanLoc = e.target.dataset.scanLocation;
                showMapPreview(pointLoc, scanLoc);
            }
            if (e.target.classList.contains('add-log-btn') || e.target.classList.contains('edit-log-btn')) {
                const isEdit = e.target.classList.contains('edit-log-btn');
                const scheduleId = e.target.closest('tr').dataset.scheduleId;
                const pointId = e.target.closest('tr').dataset.pointId;
                const logId = isEdit ? e.target.dataset.logId : null;
                await openManualLogModal(scheduleId, pointId, logId);
            }
            if (e.target.classList.contains('delete-log-btn')) {
                const logId = e.target.dataset.logId;
                if (confirm('確定要刪除這筆紀錄嗎？')) {
                    await deleteDoc(doc(db, 'patrol_logs', logId));
                    loadAndRenderDataPage(); // Refresh data page
                    closeModal(logDetailsModal);
                }
            }

        });

        // Event listeners for filters
        document.getElementById('filter-community').addEventListener('change', listenForSchedules);
        document.getElementById('filter-user').addEventListener('change', listenForSchedules);
        document.getElementById('clear-filters-btn').addEventListener('click', () => {
            document.getElementById('filter-community').value = '';
            document.getElementById('filter-user').value = '';
            listenForSchedules();
        });
        
        // Map Modal Listeners
        document.getElementById('confirm-map-selection-btn').addEventListener('click', () => {
            if (currentGpsTargetInput && marker) {
                const latLng = marker.getLatLng();
                currentGpsTargetInput.value = `${latLng.lat.toFixed(6)}, ${latLng.lng.toFixed(6)}`;
            }
            closeModal(mapModal);
        });
        document.getElementById('close-map-modal-btn').addEventListener('click', () => closeModal(mapModal));
        document.getElementById('close-map-preview-modal-btn').addEventListener('click', () => closeModal(mapPreviewModal));
        document.getElementById('print-log-btn').addEventListener('click', () => {
             document.getElementById('print-date').textContent = `報告生成時間: ${new Date().toLocaleString()}`;
             window.print();
        });


        // Populate User Role Dropdown and handle visibility of community dropdown
        const userRoleSelect = document.getElementById('user-role');
        Object.values(ROLES).forEach(role => {
            const option = document.createElement('option');
            option.value = role;
            option.textContent = role;
            userRoleSelect.appendChild(option);
        });
        userRoleSelect.addEventListener('change', (e) => {
            const communityContainer = document.getElementById('user-community-container');
            if (e.target.value === ROLES.CHIEF) {
                communityContainer.classList.remove('hidden');
            } else {
                communityContainer.classList.add('hidden');
            }
        });

        // Generate weekly time inputs in schedule modal
        const weeklyTimesContainer = document.getElementById('weekly-times-container');
        const daysOfWeek = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
        daysOfWeek.forEach((day, index) => {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between';
            div.innerHTML = `
                <div class="flex items-center">
                    <input id="schedule-day-${index}" type="checkbox" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                    <label for="schedule-day-${index}" class="ml-3 block text-sm font-medium text-gray-700">${day}</label>
                </div>
                <input type="time" id="schedule-time-${index}" class="w-32 px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" disabled>
            `;
            weeklyTimesContainer.appendChild(div);
            div.querySelector(`#schedule-day-${index}`).addEventListener('change', (e) => {
                div.querySelector(`#schedule-time-${index}`).disabled = !e.target.checked;
            });
        });


        // --- NFC 功能 ---
        function checkNFCSupport() {
            if ('NDEFReader' in window) {
                nfcStatus.textContent = '支援';
                nfcStatus.className = 'text-green-600';
            } else {
                nfcStatus.textContent = '不支援';
                nfcStatus.className = 'text-red-600';
            }
        }
        
        function logMessage(message) {
            if (nfcLog.children.length === 1 && nfcLog.children[0].textContent.includes('掃描紀錄將顯示於此')) {
                nfcLog.innerHTML = '';
            }
            const p = document.createElement('p');
            const time = new Date().toLocaleTimeString();
            p.innerHTML = `<span class="font-mono text-gray-400">[${time}]</span> ${message}`;
            nfcLog.prepend(p);
        }

        async function startNFCScan() {
            logMessage("準備掃描... 請靠近 NFC 標籤。");
            try {
                const ndef = new NDEFReader();
                await ndef.scan();
                
                ndef.addEventListener("readingerror", () => {
                    logMessage("<span class='text-red-500'>讀取 NFC 標籤失敗。</span>");
                });

                ndef.addEventListener("reading", ({ message, serialNumber }) => {
                    handleScanSuccess(message, serialNumber);
                });

            } catch (error) {
                logMessage(`<span class='text-red-500'>掃描錯誤: ${error}</span>`);
            }
        }

        async function handleScanSuccess(message, serialNumber) {
            let recordData = serialNumber;
            if (message && message.records.length > 0) {
                try {
                    const decoder = new TextDecoder();
                    recordData = decoder.decode(message.records[0].data);
                } catch (e) {
                    console.warn("Could not decode NDEF message, falling back to serial number.", e);
                }
            }

            const patrolPoint = activePatrol.patrolPoints.find(p => p.nfcCode === recordData);

            if (patrolPoint) {
                logMessage(`✅ 成功感應！巡邏點: <span class="font-bold">${patrolPoint.name}</span>`);
                logMessage("正在獲取GPS位置...");
                getGPSLocation(
                    (coords) => {
                        logMessage(`GPS位置已獲取: ${coords}`);
                        savePatrolLog(patrolPoint, new Date(), coords);
                    },
                    () => { // Error callback
                        logMessage("<span class='text-red-500'>無法獲取GPS位置，紀錄將標示為異常。</span>");
                        savePatrolLog(patrolPoint, new Date(), null); // Save without location
                    }
                );
            } else {
                logMessage(`❌ 未知的標籤: ${recordData}`);
            }
        }
        
        async function savePatrolLog(patrolPoint, timestamp, scanLocation) {
            if (!currentUser || !activePatrol) {
                logMessage("<span class='text-red-500'>錯誤：使用者或任務未定義，無法儲存紀錄。</span>");
                return;
            }
            try {
                const logData = {
                    userId: currentUser.uid,
                    userName: userProfile.name,
                    scheduleId: activePatrol.id,
                    communityId: activePatrol.communityId,
                    communityName: activePatrol.communityName,
                    patrolPointId: patrolPoint.internalId,
                    patrolPointName: patrolPoint.name,
                    patrolPointCode: patrolPoint.code,
                    nfcCode: patrolPoint.nfcCode,
                    timestamp: timestamp,
                    scanLocation: scanLocation || null
                };
                await addDoc(collection(db, "patrol_logs"), logData);
                logMessage(`💾 紀錄已儲存至雲端`);
            } catch (error) {
                console.error("寫入 Firestore 失敗: ", error);
                logMessage("<span class='text-red-500'>儲存紀錄至雲端失敗！</span>");
            }
        }
        
        // --- Helper Functions ---
        function generateAlphanumericCode(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function calculateDistance(coords1Str, coords2Str) {
            if (!coords1Str || !coords2Str) return Infinity;
            
            try {
                const [lat1, lon1] = coords1Str.split(',').map(Number);
                const [lat2, lon2] = coords2Str.split(',').map(Number);

                if (isNaN(lat1) || isNaN(lon1) || isNaN(lat2) || isNaN(lon2)) return Infinity;

                const R = 6371e3; // metres
                const φ1 = lat1 * Math.PI/180;
                const φ2 = lat2 * Math.PI/180;
                const Δφ = (lat2-lat1) * Math.PI/180;
                const Δλ = (lon2-lon1) * Math.PI/180;

                const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                        Math.cos(φ1) * Math.cos(φ2) *
                        Math.sin(Δλ/2) * Math.sin(Δλ/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

                return R * c; // in metres
            } catch (e) {
                console.error("Error calculating distance:", e);
                return Infinity;
            }
        }
        
        function getGPSLocation(successCallback, errorCallback) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude.toFixed(6);
                        const lon = position.coords.longitude.toFixed(6);
                        if(successCallback) successCallback(`${lat}, ${lon}`);
                    },
                    (error) => {
                        alert(`無法獲取GPS位置: ${error.message}`);
                        console.error("GPS Error:", error);
                        if (errorCallback) errorCallback(error);
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                alert("您的瀏覽器不支援GPS定位。");
                if (errorCallback) errorCallback(new Error("Geolocation not supported"));
            }
        }

        function initializeMapForSelection(targetInputId) {
            currentGpsTargetInput = document.getElementById(targetInputId);
            openModal(mapModal);

            const initialCoords = currentGpsTargetInput.value.split(',').map(s => parseFloat(s.trim()));
            let lat = 25.0018; // Default to Zhonghe, New Taipei
            let lng = 121.4975;
            let zoom = 15;

            if (initialCoords.length === 2 && !isNaN(initialCoords[0]) && !isNaN(initialCoords[1])) {
                lat = initialCoords[0];
                lng = initialCoords[1];
                zoom = 18;
            }

            if (!map) {
                map = L.map('map-container').setView([lat, lng], zoom);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(map);
                marker = L.marker([lat, lng], { draggable: true }).addTo(map);
            } else {
                map.setView([lat, lng], zoom);
                marker.setLatLng([lat, lng]);
            }

            setTimeout(() => map.invalidateSize(), 100);

            if (!currentGpsTargetInput.value && navigator.geolocation) {
                 navigator.geolocation.getCurrentPosition(position => {
                     const userLat = position.coords.latitude;
                     const userLng = position.coords.longitude;
                     map.setView([userLat, userLng], 16);
                     marker.setLatLng([userLat, userLng]);
                 }, () => {
                    console.warn("Could not get user's location, using default.");
                 });
            }
        }

        function showMapPreview(pointLocation, scanLocation) {
            if (!pointLocation) {
                alert("未設定巡邏點的GPS位置。");
                return;
            }

            openModal(mapPreviewModal);

            const pointCoords = pointLocation.split(',').map(Number);
            const bounds = L.latLngBounds([pointCoords]);

            if (!mapPreview) {
                mapPreview = L.map('map-preview-container').setView(pointCoords, 18);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(mapPreview);
            } else {
                if (pointMarker) mapPreview.removeLayer(pointMarker);
                if (scanMarker) mapPreview.removeLayer(scanMarker);
                if (locationCircle) mapPreview.removeLayer(locationCircle);
            }

            pointMarker = L.marker(pointCoords).addTo(mapPreview)
                .bindPopup('預設巡邏點').openPopup();

            locationCircle = L.circle(pointCoords, {
                color: 'green',
                fillColor: '#8f8',
                fillOpacity: 0.3,
                radius: 20
            }).addTo(mapPreview);

            if (scanLocation) {
                const scanCoords = scanLocation.split(',').map(Number);
                if (scanCoords.length === 2 && !isNaN(scanCoords[0])) {
                    scanMarker = L.marker(scanCoords, { 
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                        }) 
                    }).addTo(mapPreview).bindPopup('實際感應位置');
                    bounds.extend(scanCoords);
                }
            }
            
            mapPreview.fitBounds(bounds, { padding: [50, 50] });
            setTimeout(() => mapPreview.invalidateSize(), 100);
        }


        // --- 功能性事件監聽 ---
        togglePasswordBtn.addEventListener('click', () => {
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';
            eyeIcon.classList.toggle('hidden', isPassword);
            eyeOffIcon.classList.toggle('hidden', !isPassword);
        });

        function checkRememberedEmail() {
            const rememberedEmail = localStorage.getItem('rememberedEmail');
            if (rememberedEmail) {
                emailInput.value = rememberedEmail;
                rememberMeCheckbox.checked = true;
            }
        }

        // --- 初始化檢查 ---
        checkNFCSupport();
        checkRememberedEmail();
    </script>
</body>
</html>
