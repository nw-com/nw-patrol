<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>西北保全巡邏打卡系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        /* 全局樣式和字體 */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent; /* 移除行動裝置點擊高亮 */
        }
        /* 頁面容器，符合上下 50px, 左右 10px 的邊界要求 */
        #main-page-container {
            position: fixed;
            top: 50px;
            left: 10px;
            right: 10px;
            bottom: 50px;
            display: flex;
            flex-direction: column;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        /* 頁首和頁尾的固定高度 */
        #main-header, #main-footer {
            height: 70px;
            flex-shrink: 0;
        }
        /* 頁中內容區域填滿剩餘空間 */
        #main-content {
            flex-grow: 1;
            overflow-y: auto; /* 當內容過多時，允許滾動 */
            background-color: #f9fafb; /* 頁中背景色 */
        }
        /* 導航按鈕的活動狀態 */
        .nav-btn.active {
            color: #ef4444; /* 紅色 */
            background-color: #fee2e2; /* 淡紅色背景 */
        }
        /* 讓表格在小螢幕上可以滾動 */
        .table-container {
            overflow-x: auto;
        }
        #map-container, #map-preview-container, #patrol-map-container {
            width: 100%;
        }
        /* 固定地圖高度，避免高度為 0 導致地圖無法顯示 */
        #map-container { height: 24rem; }
        #map-preview-container { height: 24rem; }
        #patrol-map-container { height: 24rem; position: relative; padding-bottom: 56px; }

        /* 列印樣式 */
        @media print {
            @page {
                size: A4;
                margin: 1cm;
            }
            body > *:not(#print-content-wrapper) {
                display: none;
            }
            #print-content-wrapper, #print-content-wrapper * {
                display: block;
                visibility: visible;
            }
            #print-content-wrapper {
                position: static;
            }
            #print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 2rem;
                border-bottom: 1px solid #ccc;
                padding-bottom: 1rem;
            }
            .print-hide { display: none !important; }
            table {
                width: 100%;
                border-collapse: collapse;
                font-size: 10pt;
            }
            th, td {
                border: 1px solid #ddd;
                padding: 6px;
                text-align: left;
            }
            th {
                background-color: #f2f2f2 !important;
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }
            tr.bg-green-50 {
                background-color: #e6ffed !important;
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }
            tr.bg-red-50 {
                background-color: #ffe5e5 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .print-hide {
                display: none !important;
            }
             a {
                text-decoration: none;
                color: inherit;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- App 根容器 -->
    <div id="app">

        <!-- 登入頁面 -->
        <div id="login-page" class="flex items-center justify-center min-h-screen p-4">
            <div class="w-full max-w-sm mx-auto bg-white p-8 rounded-2xl shadow-lg text-center">
                <!-- Logo -->
                <svg class="mx-auto h-12 w-auto text-red-500 mb-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">西北保全巡邏打卡系統</h1>
                <p class="text-center text-gray-500 mb-6">請登入您的帳號</p>
                <form id="login-form">
                    <div class="mb-4 text-left">
                        <div class="flex justify-between items-center mb-1">
                            <label for="email" class="block text-sm font-medium text-gray-700">帳號 (Email)</label>
                            <div class="flex items-center">
                                <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                                <label for="remember-me" class="ml-2 block text-sm text-gray-900">記住我</label>
                            </div>
                        </div>
                        <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="user@example.com" required>
                    </div>
                    <div class="mb-6 text-left">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密碼</label>
                        <div class="relative">
                            <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="••••••••" required>
                            <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500">
                                <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                <svg id="eye-off-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        登入
                    </button>
                    <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
                </form>
            </div>
        </div>

        <!-- 主應用程式頁面 (登入後顯示) -->
        <div id="main-page" class="hidden">
            <div id="main-page-container" class="bg-white">
                <!-- 頁首 -->
                <header id="main-header" class="bg-white border-b border-gray-200 flex items-center justify-between px-4">
                    <div class="flex items-center space-x-2 min-w-0">
                        <svg class="h-8 w-8 text-red-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                        <div class="min-w-0">
                             <h1 class="text-md sm:text-xl font-bold text-gray-800 truncate">西北保全巡邏打卡系統</h1>
                        </div>
                    </div>
                    <div class="relative">
                         <button id="welcome-button" class="text-sm font-semibold text-gray-700 truncate p-2 rounded-md hover:bg-gray-100"></button>
                         <div id="logout-popup" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-xl z-20 py-1">
                             <div class="px-4 py-2 text-sm text-gray-700">確定要登出嗎？</div>
                             <div class="flex justify-around p-2">
                                 <button id="confirm-logout-btn" class="text-sm bg-red-500 text-white rounded-md px-3 py-1 hover:bg-red-600">登出</button>
                                 <button id="cancel-logout-btn" class="text-sm bg-gray-200 text-gray-800 rounded-md px-3 py-1 hover:bg-gray-300">取消</button>
                             </div>
                         </div>
                    </div>
                </header>

                <!-- 頁中 (主要內容) -->
                <main id="main-content" class="p-4">
                    <!-- 各分頁內容會在這裡切換顯示 -->
    <div id="page-home" class="page-content">
        <!-- 目前日期時間列（首頁顯示）：放大置中 -->
        <div id="current-time-bar" class="bg-gray-100 text-gray-800 px-4 py-3 border-b">
            <span id="current-time-text" class="block text-center text-2xl font-semibold tracking-wide"></span>
        </div>
                        <h2 class="text-2xl font-bold mb-4">首頁</h2>
                        <div class="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded-lg">
                            <p class="font-bold">歡迎使用！</p>
                            <p>請點擊下方導航按鈕開始操作。</p>
                        </div>
                         <div class="mt-6">
                            <h3 class="font-semibold text-lg mb-2">系統狀態</h3>
                            <div class="p-4 bg-white rounded-lg shadow-sm space-y-2">
                                <p><strong>NFC 功能:</strong> <span id="nfc-status">檢測中...</span></p>
                                <p><strong>Firebase 連線:</strong> <span id="firebase-status" class="text-gray-400">尚未連接</span></p>
                            </div>
                        </div>
                    </div>

    <div id="page-patrol" class="page-content hidden">
        <div id="patrol-calendar" class="mb-4 bg-white rounded-lg shadow border p-4">
            <div class="flex items-center justify-between">
                <button id="cal-prev" class="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200 text-sm">上月</button>
                <div id="cal-month-label" class="font-bold text-lg"></div>
                <button id="cal-next" class="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200 text-sm">下月</button>
            </div>
            <div class="mt-3 grid grid-cols-7 gap-1 text-center text-xs text-gray-500">
                <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
            </div>
            <div id="patrol-calendar-days" class="mt-2 grid grid-cols-7 gap-2"></div>
        </div>
        <h2 id="selected-date-title" class="text-2xl font-bold mb-2">今日巡邏任務</h2>
        <div id="todays-patrols-list" class="space-y-4">
            <!-- Selected date patrols will be loaded here -->
        </div>
    </div>

                    <div id="page-data" class="page-content hidden">
                        <h2 class="text-2xl font-bold mb-4">巡邏紀錄查詢</h2>
                        <!-- Tabs -->
                        <div id="data-tabs" class="mb-4 flex gap-2">
                            <button id="tab-daily" class="px-4 py-2 rounded-md bg-red-500 text-white">每日</button>
                            <button id="tab-monthly" class="px-4 py-2 rounded-md bg-gray-200 text-gray-700">每月</button>
                        </div>
                         <!-- Filter Section -->
                        <div id="data-filters" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 bg-gray-50 p-4 rounded-lg">
                            <div>
                                <label for="data-filter-date" class="block text-sm font-medium text-gray-700">選擇日期</label>
                                <input type="date" id="data-filter-date" class="mt-1 block w-full pl-3 pr-2 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md">
                            </div>
                            <div id="data-community-filter-container" class="hidden">
                                <label for="data-filter-community" class="block text-sm font-medium text-gray-700">依社區篩選</label>
                                <select id="data-filter-community" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md">
                                    <!-- options will be populated by JS -->
                                </select>
                            </div>
                            <div class="self-end">
                                <button id="data-apply-filters-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">查詢紀錄</button>
                            </div>
                        </div>
                        <div id="data-logs-container" class="space-y-4">
                            <!-- Daily log summaries will be loaded here -->
                        </div>
                        <div id="data-monthly-container" class="space-y-4 hidden">
                            <!-- Monthly view will be rendered here -->
                        </div>
                    </div>

                    <div id="page-schedule" class="page-content hidden space-y-6">
                        <div>
                             <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-gray-800">排程管理</h2>
                                <button id="add-schedule-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">新增排程</button>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label for="filter-community" class="block text-sm font-medium text-gray-700">依社區篩選</label>
                                    <select id="filter-community" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md">
                                    </select>
                                </div>
                                <div>
                                     <label for="filter-user" class="block text-sm font-medium text-gray-700">依人員篩選</label>
                                    <select id="filter-user" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md">
                                    </select>
                                </div>
                                <div class="self-end">
                                    <button id="clear-filters-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg text-sm">清除篩選</button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow overflow-hidden table-container">
                             <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-4 py-3">社區名稱</th>
                                        <th scope="col" class="px-4 py-3">巡邏編號</th>
                                        <th scope="col" class="px-4 py-3">巡邏點</th>
                                        <th scope="col" class="px-4 py-3">排程時間</th>
                                        <th scope="col" class="px-4 py-3">人員</th>
                                        <th scope="col" class="px-4 py-3 text-right">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="schedules-list">
                                    <!-- Schedule data will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="page-settings" class="page-content hidden space-y-8">
                        <!-- 服務社區管理 -->
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-800">服務社區列表</h3>
                                <button id="add-community-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">新增社區</button>
                            </div>
                            <div class="bg-white rounded-lg shadow overflow-hidden table-container">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-4 py-3">社區編號</th>
                                            <th scope="col" class="px-4 py-3">社區名稱</th>
                                            <th scope="col" class="px-4 py-3">GPS位置</th>
                                            <th scope="col" class="px-4 py-3 text-right">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="communities-list">
                                        <!-- Data will be populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    
                        <!-- 帳號管理 -->
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-800">帳號列表</h3>
                                <button id="add-user-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">新增帳號</button>
                            </div>
                            <div class="bg-white rounded-lg shadow table-container">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-4 py-3">角色</th>
                                            <th scope="col" class="px-4 py-3">姓名</th>
                                            <th scope="col" class="px-4 py-3">電子郵件(帳號)</th>
                                            <th scope="col" class="px-4 py-3 text-right">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-list">
                                        <!-- Data will be populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </main>

                <!-- 頁尾 (導航欄) -->
                <footer id="main-footer" class="bg-white border-t border-gray-200 flex justify-around items-center">
                    <!-- 導航按鈕會根據權限動態生成 -->
                </footer>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="community-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="community-modal-title">新增社區</h3>
                <div class="mt-2 px-7 py-3">
                    <form id="community-form" onsubmit="return false;" class="space-y-4">
                        <input type="hidden" id="community-id-input">
                        <div>
                            <label for="community-code" class="text-left block text-sm font-medium text-gray-700">社區編號</label>
                            <input type="text" id="community-code" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div>
                            <label for="community-name" class="text-left block text-sm font-medium text-gray-700">社區名稱</label>
                            <input type="text" id="community-name" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div>
                            <label for="community-gps" class="text-left block text-sm font-medium text-gray-700">定位社區GPS</label>
                             <div class="flex items-center space-x-2 mt-1">
                                <input type="text" id="community-gps" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="點擊右側按鈕在地圖上選點">
                                <button type="button" class="get-gps-btn p-2 bg-blue-500 text-white rounded-md hover:bg-blue-600" data-target="community-gps">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="items-center px-4 py-3 text-center">
                    <button id="save-community-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">儲存</button>
                    <button id="close-community-modal-btn" class="ml-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">取消</button>
                </div>
            </div>
        </div>
    </div>

    <div id="user-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="user-modal-title">新增帳號</h3>
                <div class="mt-2 px-7 py-3">
                    <form id="user-form" onsubmit="return false;">
                        <input type="hidden" id="user-id-input">
                         <div class="mb-4">
                            <label for="user-role" class="text-left block text-sm font-medium text-gray-700">角色</label>
                            <select id="user-role" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="user-name" class="text-left block text-sm font-medium text-gray-700">姓名</label>
                            <input type="text" id="user-name" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div id="user-community-container" class="mb-4 hidden">
                            <label for="user-community" class="text-left block text-sm font-medium text-gray-700">所屬社區</label>
                            <select id="user-community" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500"></select>
                            <p class="text-xs text-left text-gray-500 mt-1">為「總幹事」角色指定一個管理的社區。</p>
                        </div>
                        <div class="mb-4">
                            <label for="user-email" class="text-left block text-sm font-medium text-gray-700">電子郵件 (帳號)</label>
                            <input type="email" id="user-email" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div id="password-container" class="mb-4">
                            <label for="user-password" class="text-left block text-sm font-medium text-gray-700">密碼</label>
                            <input type="text" id="user-password" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                            <p id="password-help-text" class="text-xs text-left text-gray-500 mt-1">新增帳號時為必填 (至少6個字元)。</p>
                        </div>
                    </form>
                </div>
                <div class="items-center px-4 py-3 text-center">
                    <button id="save-user-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">儲存</button>
                    <button id="close-user-modal-btn" class="ml-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">取消</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="schedule-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="schedule-modal-title">新增排程</h3>
                 <div class="mt-2 px-7 py-3 space-y-4">
                     <form id="schedule-form" onsubmit="return false;" class="space-y-4">
                         <input type="hidden" id="schedule-id-input">
                          <div>
                             <label for="schedule-community" class="text-left block text-sm font-medium text-gray-700">社區名稱</label>
                             <select id="schedule-community" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required></select>
                         </div>
                         <div>
                            <label for="schedule-patrol-code" class="text-left block text-sm font-medium text-gray-700">巡邏編號</label>
                            <input type="text" id="schedule-patrol-code" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <div>
                            <label for="schedule-user" class="text-left block text-sm font-medium text-gray-700">人員 (保全/總幹事)</label>
                            <select id="schedule-user" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required></select>
                        </div>
                        <div>
                            <label class="text-left block text-sm font-medium text-gray-700">每日巡邏時間</label>
                            <div id="weekly-times-container" class="mt-2 space-y-2 p-3 bg-gray-50 rounded-md border">
                                <!-- Daily time inputs will be generated here -->
                            </div>
                        </div>
                     </form>
                 </div>
                 <div class="items-center px-4 py-3 text-center">
                    <button id="save-schedule-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">儲存</button>
                    <button id="close-schedule-modal-btn" class="ml-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">取消</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="patrol-points-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-5 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                 <h3 class="text-lg leading-6 font-medium text-gray-900" id="patrol-points-modal-title">管理巡邏點</h3>
                 <p id="patrol-points-schedule-info" class="text-sm text-gray-500 mb-4"></p>

                <!-- Add/Edit Patrol Point Form -->
                 <form id="patrol-point-form" onsubmit="return false;" class="p-4 border rounded-md bg-gray-50 space-y-4 mb-4">
                     <h4 class="font-semibold" id="patrol-point-form-title">新增巡邏點</h4>
                     <input type="hidden" id="patrol-point-internal-id">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="patrol-point-code" placeholder="巡邏點編號" class="px-3 py-2 border border-gray-300 rounded-md" required>
                         <div class="flex items-center space-x-2">
                            <input type="text" id="patrol-point-location" placeholder="定位位置" class="flex-grow px-3 py-2 border border-gray-300 rounded-md" required>
                            <button type="button" class="get-gps-btn p-2 bg-blue-500 text-white rounded-md hover:bg-blue-600" data-target="patrol-point-location">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                            </button>
                         </div>
                     </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <input type="text" id="patrol-point-name" placeholder="巡邏點名稱" class="px-3 py-2 border border-gray-300 rounded-md" required>
                         <div class="flex items-center space-x-2">
                            <input type="text" id="patrol-point-nfc-code" placeholder="NFC Code (16碼)" class="flex-grow px-3 py-2 border border-gray-300 rounded-md bg-gray-200" readonly>
                            <button id="generate-nfc-code-btn" type="button" class="px-3 py-2 bg-blue-500 text-white rounded-md text-sm">產生</button>
                         </div>
                     </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <textarea id="patrol-point-desc" placeholder="巡邏點描述（選填）" class="px-3 py-2 border border-gray-300 rounded-md"></textarea>
                         <label class="flex items-center space-x-2">
                             <input type="checkbox" id="patrol-point-requires-confirm" class="h-4 w-4 border-gray-300 rounded">
                             <span>到點需確認（例如拍照或簽名）</span>
                         </label>
                     </div>
                     <div>
                         <button id="save-patrol-point-btn" type="submit" class="px-4 py-2 bg-red-500 text-white rounded-md">儲存巡邏點</button>
                         <button id="cancel-edit-point-btn" type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hidden">取消編輯</button>
                     </div>
                 </form>

                <!-- List of Patrol Points -->
                <div class="table-container max-h-64 overflow-y-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2">編號</th>
                                <th class="px-4 py-2">名稱</th>
                                <th class="px-4 py-2">位置</th>
                                <th class="px-4 py-2">描述</th>
                                <th class="px-4 py-2">需確認</th>
                                <th class="px-4 py-2">NFC Code</th>
                                <th class="px-4 py-2 text-right">操作</th>
                            </tr>
                        </thead>
                        <tbody id="patrol-points-list">
                            <!-- Points will be populated by JS -->
                        </tbody>
                    </table>
                </div>

                 <div class="items-center px-4 py-3 text-right">
                    <button id="close-patrol-points-modal-btn" class="px-4 py-2 bg-gray-800 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-700">完成</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="map-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-[5000]">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white">
             <h3 class="text-lg leading-6 font-medium text-gray-900">在地圖上選擇位置</h3>
             <p class="text-sm text-gray-500 mb-4">拖動圖釘以確定精確位置</p>
             <div id="map-container" class="rounded-md z-0 h-96 w-full"></div>
             <div class="items-center px-4 py-3 text-center">
                <button id="confirm-map-selection-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">確定位置</button>
                <button id="close-map-modal-btn" class="ml-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">取消</button>
            </div>
        </div>
    </div>

    <div id="log-details-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div id="print-area" class="relative top-5 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                 <div id="print-header" class="hidden">
                    <h1 class="text-2xl font-bold">巡邏紀錄報告</h1>
                    <p class="text-sm text-gray-600" id="print-date"></p>
                 </div>
                 <h3 class="text-lg leading-6 font-medium text-gray-900" id="log-details-modal-title">巡邏點紀錄</h3>
                 <div class="mt-4 table-container">
                    <table class="w-full text-sm text-left text-gray-500" id="log-details-table">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="px-4 py-2">社區</th>
                                <th class="px-4 py-2">保全</th>
                                <th class="px-4 py-2">巡邏點編號</th>
                                <th class="px-4 py-2">定位地圖</th>
                                <th class="px-4 py-2">感應時間</th>
                                <th class="px-4 py-2">狀態</th>
                            </tr>
                        </thead>
                        <tbody id="log-details-list">
                            <!-- Log details will be populated by JS -->
                        </tbody>
                    </table>
                 </div>
                 <div class="items-center px-4 py-3 text-right print-hide">
                    <button id="print-log-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-blue-600">列印/匯出PDF</button>
                    <button id="close-log-details-modal-btn" class="px-4 py-2 bg-gray-800 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-700">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <div id="map-preview-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-[4800]">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white">
             <h3 class="text-lg leading-6 font-medium text-gray-900">地圖預覽</h3>
             <p class="text-sm text-gray-500 mb-4">藍色圖釘為預設巡邏點，紅色為實際感應位置。</p>
             <div id="map-preview-container" class="rounded-md z-0 h-96 w-full"></div>
             <div class="items-center px-4 py-3 text-right">
                <button id="close-map-preview-modal-btn" class="px-4 py-2 bg-gray-800 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-700">關閉</button>
            </div>
        </div>
    </div>

    <div id="manual-log-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="manual-log-modal-title">手動紀錄</h3>
            <form id="manual-log-form" onsubmit="return false;" class="mt-4 space-y-4">
                <input type="hidden" id="manual-log-id">
                <input type="hidden" id="manual-log-schedule-id">
                <input type="hidden" id="manual-log-point-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700">巡邏點</label>
                    <p id="manual-log-point-name" class="mt-1 text-gray-800 font-semibold"></p>
                </div>
                <div>
                    <label for="manual-log-datetime" class="block text-sm font-medium text-gray-700">感應日期時間</label>
                    <input type="datetime-local" id="manual-log-datetime" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label for="manual-log-location" class="block text-sm font-medium text-gray-700">感應位置 (GPS)</label>
                    <div class="flex items-center space-x-2 mt-1">
                        <input type="text" id="manual-log-location" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        <button type="button" class="get-gps-btn p-2 bg-blue-500 text-white rounded-md" data-target="manual-log-location">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                        </button>
                    </div>
                </div>
                 <div class="items-center pt-4 text-center">
                    <button id="save-manual-log-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md">儲存紀錄</button>
                    <button id="close-manual-log-modal-btn" class="ml-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md">取消</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="patrol-map-modal" class="fixed inset-0 bg-white z-[1500] hidden">
        <header class="h-16 bg-white border-b flex justify-between items-center px-4">
            <h3 id="patrol-map-title" class="text-lg font-bold">巡邏地圖</h3>
            <button id="close-patrol-map-btn" class="text-gray-600 hover:text-gray-900">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </header>
        <div id="patrol-map-container" style="height: calc(100vh - 64px); position: relative;">
            <div id="patrol-point-buttons" class="fixed left-0 right-0 bg-white/95 border-t shadow-md px-3 py-2 flex gap-2 overflow-x-auto z-[6000]"
                 style="bottom: 0; padding-bottom: env(safe-area-inset-bottom, 0px);">
            </div>
        </div>
    </div>

    <div id="nfc-point-scan-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden z-[7000]">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <h3 id="nfc-scan-point-name" class="text-xl font-bold mb-2"></h3>
            <p class="text-gray-600 mb-4">請靠近對應的NFC標籤...</p>
            <div id="nfc-scan-log" class="text-left text-sm text-gray-700 bg-gray-50 p-3 rounded-lg h-24 overflow-y-auto"></div>
             <button id="close-nfc-scan-modal-btn" class="mt-4 px-4 py-2 bg-gray-200 text-gray-800 rounded-md">取消</button>
        </div>
    </div>

    <!-- Print container -->
    <div id="print-content-wrapper" class="hidden"></div>


    <!-- Firebase SDKs -->
    <script type="module">
        // 匯入 Firebase 模組
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, query, updateDoc, deleteDoc, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase 設定 ---
        const firebaseConfig = {
            apiKey: "AIzaSyBaBL7rKPnqpz8hbfILWq6cDWdZust13xM",
            authDomain: "nw-patrol.firebaseapp.com",
            projectId: "nw-patrol",
            storageBucket: "nw-patrol.appspot.com",
            messagingSenderId: "157808049159",
            appId: "1:157808049159:web:6f9128d16cb9919d50bea2",
            measurementId: "G-44B5L4KH1Q"
        };
        
        // --- 應用程式初始化 ---
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            document.getElementById('firebase-status').textContent = '已連接';
            document.getElementById('firebase-status').className = 'text-green-600';
        } catch(e) {
            console.error("Firebase 初始化失敗:", e);
            document.getElementById('firebase-status').textContent = '連接失敗';
            document.getElementById('firebase-status').className = 'text-red-600';
            alert("Firebase 初始化失敗，請檢查您的設定。");
        }


        // --- 變數與 DOM 元素 ---
        const loginPage = document.getElementById('login-page');
        const mainPage = document.getElementById('main-page');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const welcomeButton = document.getElementById('welcome-button');
        const logoutPopup = document.getElementById('logout-popup');
        const mainFooter = document.getElementById('main-footer');
        const nfcStatus = document.getElementById('nfc-status');
        const passwordInput = document.getElementById('password');
        const togglePasswordBtn = document.getElementById('toggle-password');
        const eyeIcon = document.getElementById('eye-icon');
        const eyeOffIcon = document.getElementById('eye-off-icon');
        const rememberMeCheckbox = document.getElementById('remember-me');
        const emailInput = document.getElementById('email');
        
        // Settings page elements
        const communitiesList = document.getElementById('communities-list');
        const usersList = document.getElementById('users-list');
        const communityModal = document.getElementById('community-modal');
        const userModal = document.getElementById('user-modal');

        // Schedule page elements
        const scheduleModal = document.getElementById('schedule-modal');
        const patrolPointsModal = document.getElementById('patrol-points-modal');
        const schedulesList = document.getElementById('schedules-list');

        // Patrol page elements
        const todaysPatrolsList = document.getElementById('todays-patrols-list');
        const patrolMapModal = document.getElementById('patrol-map-modal');
        const nfcPointScanModal = document.getElementById('nfc-point-scan-modal');
        const nfcScanLog = document.getElementById('nfc-scan-log');

        // Data page elements
        const dataLogsContainer = document.getElementById('data-logs-container');
        const logDetailsModal = document.getElementById('log-details-modal');
        const manualLogModal = document.getElementById('manual-log-modal');
        
        // Map elements
        const mapModal = document.getElementById('map-modal');
        const mapPreviewModal = document.getElementById('map-preview-modal');


        let currentUser = null;
        let userProfile = null;
        let communitiesUnsubscribe = null;
        let usersUnsubscribe = null;
        let schedulesUnsubscribe = null;
        let editingCommunityId = null;
        let editingUserId = null;
        let editingScheduleId = null;
        let currentScheduleForPoints = null; // Holds the full schedule object being edited for points
        let activePatrol = null; // Holds schedule data for the currently active patrol scan
        
        let map = null;
        let marker = null;
        let currentGpsTargetInput = null;

        let mapPreview = null;
        let pointMarker = null;
        let scanMarker = null;
        let locationCircle = null;

        let patrolMap = null;
        let patrolPointMarkers = {};


        // --- 權限設定 ---
        const ROLES = {
            ADMIN: '管理員',
            EXECUTIVE: '高階主管',
            CHIEF: '總幹事',
            GUARD: '保全'
        };

        const PAGE_PERMISSIONS = {
            'home': [ROLES.ADMIN, ROLES.EXECUTIVE, ROLES.CHIEF, ROLES.GUARD],
            'patrol': [ROLES.CHIEF, ROLES.GUARD],
            'data': [ROLES.ADMIN, ROLES.EXECUTIVE, ROLES.CHIEF, ROLES.GUARD],
            'schedule': [ROLES.ADMIN, ROLES.EXECUTIVE, ROLES.CHIEF],
            'settings': [ROLES.ADMIN]
        };
        
        const NAV_ITEMS = [
            { id: 'home', label: '首頁', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>` },
            { id: 'patrol', label: '巡邏', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg>` },
            { id: 'data', label: '資料', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>` },
            { id: 'schedule', label: '排程', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>` },
            { id: 'settings', label: '設定', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>` },
        ];


        // --- 認證流程 ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userProfileRef = doc(db, "users", user.uid);
                const userProfileSnap = await getDoc(userProfileRef);

                if (userProfileSnap.exists()) {
                    userProfile = userProfileSnap.data();
                    
                    welcomeButton.textContent = `歡迎~${userProfile.name}`;
                    loginPage.classList.add('hidden');
                    mainPage.classList.remove('hidden');
                    renderNavigation();
                    navigateTo('home');
                } else {
                    console.error("找不到使用者設定檔:", user.uid);
                    loginError.textContent = "無法載入使用者資料，請聯繫管理員。";
                    await signOut(auth);
                }
            } else {
                currentUser = null;
                userProfile = null;
                loginPage.classList.remove('hidden');
                mainPage.classList.add('hidden');
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            loginError.textContent = '';
            if (rememberMeCheckbox.checked) {
                localStorage.setItem('rememberedEmail', email);
            } else {
                localStorage.removeItem('rememberedEmail');
            }
            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    console.error("登入失敗:", error);
                    loginError.textContent = '帳號或密碼錯誤。';
                });
        });

        welcomeButton.addEventListener('click', () => {
            logoutPopup.classList.toggle('hidden');
        });

        document.getElementById('confirm-logout-btn').addEventListener('click', () => {
             signOut(auth);
             logoutPopup.classList.add('hidden');
        });
        
        document.getElementById('cancel-logout-btn').addEventListener('click', () => {
             logoutPopup.classList.add('hidden');
        });

        
        // --- 導航與頁面渲染 ---
        function renderNavigation() {
            mainFooter.innerHTML = '';
            NAV_ITEMS.forEach(item => {
                if (PAGE_PERMISSIONS[item.id] && PAGE_PERMISSIONS[item.id].includes(userProfile.role)) {
                    const btn = document.createElement('button');
                    btn.className = 'nav-btn flex flex-col items-center justify-center w-full h-full text-gray-500 hover:bg-gray-100 transition p-2 rounded-lg';
                    btn.dataset.page = item.id;
                    btn.innerHTML = `${item.icon}<span class="text-xs mt-1">${item.label}</span>`;
                    btn.addEventListener('click', () => navigateTo(item.id));
                    mainFooter.appendChild(btn);
                }
            });
        }
        
        function navigateTo(pageId) {
            document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
            
            if (communitiesUnsubscribe) { communitiesUnsubscribe(); communitiesUnsubscribe = null; }
            if (usersUnsubscribe) { usersUnsubscribe(); usersUnsubscribe = null; }
            if (schedulesUnsubscribe) { schedulesUnsubscribe(); schedulesUnsubscribe = null; }
            
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            
            if (pageId === 'settings') {
                listenForCommunities();
                listenForUsers();
            } else if (pageId === 'schedule') {
                populateScheduleFilters();
                listenForSchedules();
            } else if (pageId === 'patrol') {
                // 初始化月曆並預設選定今日
                const today = new Date();
                calendarState.year = today.getFullYear();
                calendarState.month = today.getMonth();
                buildCalendar(calendarState.year, calendarState.month);
                setSelectedDate(today);
                // 綁定月份切換
                const prevBtn = document.getElementById('cal-prev');
                const nextBtn = document.getElementById('cal-next');
                prevBtn.onclick = () => {
                    if (calendarState.month === 0) { calendarState.year -= 1; calendarState.month = 11; } else { calendarState.month -= 1; }
                    buildCalendar(calendarState.year, calendarState.month);
                };
                nextBtn.onclick = () => {
                    if (calendarState.month === 11) { calendarState.year += 1; calendarState.month = 0; } else { calendarState.month += 1; }
                    buildCalendar(calendarState.year, calendarState.month);
                };
            } else if (pageId === 'data') {
                const dataFilterDate = document.getElementById('data-filter-date');
                dataFilterDate.value = new Date().toISOString().split('T')[0];

                const setupFiltersAndLoad = async () => {
                    const dataCommunityFilterContainer = document.getElementById('data-community-filter-container');
                    if ([ROLES.ADMIN, ROLES.EXECUTIVE].includes(userProfile.role)) {
                        dataCommunityFilterContainer.classList.remove('hidden');
                        const communities = await getOptionsForSelect('communities', 'name');
                        populateSelect(document.getElementById('data-filter-community'), communities, '所有社區');
                    } else {
                        dataCommunityFilterContainer.classList.add('hidden');
                    }
                    loadAndRenderDataPage();
                };
                setupFiltersAndLoad();
            }
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.page === pageId);
            });
        }
        
        // --- 設定頁面 CRUD ---
        
        // Modal helpers
        function openModal(modal) { modal.classList.remove('hidden'); }
        function closeModal(modal) { modal.classList.add('hidden'); }
        
        // Community Management
        function listenForCommunities() {
            const q = query(collection(db, "communities"));
            communitiesUnsubscribe = onSnapshot(q, (querySnapshot) => {
                const communities = [];
                querySnapshot.forEach((doc) => communities.push({ id: doc.id, ...doc.data() }));
                renderCommunities(communities);
            });
        }

        function renderCommunities(communities) {
            communitiesList.innerHTML = '';
            if (communities.length === 0) {
                communitiesList.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">尚無社區資料</td></tr>`;
                return;
            }
            communities.forEach(c => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium text-gray-900 whitespace-nowrap">${c.code}</td>
                    <td class="px-4 py-3">${c.name}</td>
                    <td class="px-4 py-3 text-xs">${c.gps || '未設定'}</td>
                    <td class="px-4 py-3 text-right">
                        <button class="edit-community-btn font-medium text-blue-600 hover:underline mr-2" data-id="${c.id}">編輯</button>
                        <button class="delete-community-btn font-medium text-red-600 hover:underline" data-id="${c.id}">刪除</button>
                    </td>`;
                communitiesList.appendChild(row);
            });
        }

        async function saveCommunity() {
            const code = document.getElementById('community-code').value;
            const name = document.getElementById('community-name').value;
            const gps = document.getElementById('community-gps').value;
            if (!code || !name) { alert("請填寫所有欄位"); return; }
            
            const data = { code, name, gps };
            try {
                if (editingCommunityId) {
                    await updateDoc(doc(db, "communities", editingCommunityId), data);
                } else {
                    await addDoc(collection(db, "communities"), data);
                }
                closeModal(communityModal);
            } catch (e) {
                console.error("儲存社區失敗: ", e);
                alert("儲存失敗");
            }
        }
        
        // User Management
        function listenForUsers() {
            const q = query(collection(db, "users"));
            usersUnsubscribe = onSnapshot(q, (querySnapshot) => {
                const users = [];
                querySnapshot.forEach((doc) => users.push({ id: doc.id, ...doc.data() }));
                renderUsers(users);
            });
        }
        
        function renderUsers(users) {
            usersList.innerHTML = '';
            if (users.length === 0) {
                 usersList.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">尚無帳號資料</td></tr>`;
                 return;
            }
            users.forEach(u => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                row.innerHTML = `
                    <td class="px-4 py-3">${u.role}</td>
                    <td class="px-4 py-3 font-medium text-gray-900 whitespace-nowrap">${u.name}</td>
                    <td class="px-4 py-3">${u.email}</td>
                    <td class="px-4 py-3 text-right">
                        <button class="edit-user-btn font-medium text-blue-600 hover:underline mr-2" data-id="${u.id}">編輯</button>
                        <button class="delete-user-btn font-medium text-red-600 hover:underline" data-id="${u.id}">刪除</button>
                    </td>`;
                usersList.appendChild(row);
            });
        }

        async function saveUser() {
            const role = document.getElementById('user-role').value;
            const name = document.getElementById('user-name').value;
            const email = document.getElementById('user-email').value;
            const password = document.getElementById('user-password').value;
            if (!role || !name || !email) { 
                alert("角色、姓名和電子郵件為必填項"); 
                return; 
            }

            const data = { role, name, email };
            if (role === ROLES.CHIEF) {
                const communityId = document.getElementById('user-community').value;
                if (!communityId) {
                    alert('請為總幹事選擇一個所屬社區。');
                    return;
                }
                data.communityId = communityId;
            }

            if (editingUserId) {
                // Editing an existing user
                try {
                    await updateDoc(doc(db, "users", editingUserId), data);
                    closeModal(userModal);
                } catch (e) {
                     console.error("更新使用者失敗: ", e);
                     alert("更新失敗: " + e.message);
                }
            } else {
                // Creating a new user
                if (!password || password.length < 6) {
                    alert("新增使用者時必須設定密碼 (至少6個字元)。");
                    return;
                }

                // Use a temporary app instance to create the user without logging out the admin
                const tempAppName = 'userCreationApp_' + Date.now();
                const tempApp = initializeApp(firebaseConfig, tempAppName);
                const tempAuth = getAuth(tempApp);

                try {
                    // 1. Create user in Firebase Auth using the temporary instance
                    const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
                    const user = userCredential.user;

                    // 2. Create user profile in our main Firestore with the new user's UID
                    await setDoc(doc(db, "users", user.uid), data);

                    closeModal(userModal); // Success
                } catch (e) {
                    console.error("創建使用者失敗: ", e);
                    if (e.code === 'auth/email-already-in-use') {
                        alert("此電子郵件已被註冊。");
                    } else if (e.code === 'auth/weak-password') {
                        alert("密碼太弱，至少需要6個字元。");
                    } else {
                        alert("操作失敗: " + e.message);
                    }
                } finally {
                    // 3. Clean up the temporary app instance
                    await deleteApp(tempApp);
                }
            }
        }

        // --- 排程頁面 CRUD ---
        async function getOptionsForSelect(collectionName, textField) {
            const q = query(collection(db, collectionName));
            const snapshot = await getDocs(q);
            const options = [];
            snapshot.forEach(docSnap => {
                options.push({ id: docSnap.id, text: docSnap.data()[textField] });
            });
            return options;
        }

        async function getPatrolStaffForSelect() {
            const q = query(collection(db, "users"), where("role", "in", [ROLES.GUARD, ROLES.CHIEF]));
            const snapshot = await getDocs(q);
            const options = [];
            snapshot.forEach(docSnap => {
                options.push({ id: docSnap.id, text: `${docSnap.data().name} (${docSnap.data().role})` });
            });
            return options;
        }
        
        function populateSelect(selectElement, options, defaultOptionText = '全部') {
             selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
             options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.id;
                option.dataset.name = opt.text;
                option.textContent = opt.text;
                selectElement.appendChild(option);
             });
        }


        async function populateScheduleFilters() {
            const [communities, staff] = await Promise.all([
                getOptionsForSelect('communities', 'name'),
                getPatrolStaffForSelect()
            ]);
            populateSelect(document.getElementById('filter-community'), communities);
            populateSelect(document.getElementById('filter-user'), staff);
        }

        function listenForSchedules() {
            if (schedulesUnsubscribe) schedulesUnsubscribe();
            
            const communityFilter = document.getElementById('filter-community').value;
            const userFilter = document.getElementById('filter-user').value;

            let constraints = [];
            if (communityFilter) constraints.push(where("communityId", "==", communityFilter));
            if (userFilter) constraints.push(where("userId", "==", userFilter));
            
            const q = query(collection(db, "schedules"), ...constraints);
            schedulesUnsubscribe = onSnapshot(q, (querySnapshot) => {
                const schedules = [];
                querySnapshot.forEach((doc) => schedules.push({ id: doc.id, ...doc.data() }));
                renderSchedules(schedules);
            });
        }
        
        function formatWeeklyTimes(weeklyTimes) {
            if (!weeklyTimes || Object.keys(weeklyTimes).length === 0) {
                return '未設定';
            }
            const days = ['日', '一', '二', '三', '四', '五', '六'];
            return Object.entries(weeklyTimes)
                .map(([dayIndex, val]) => {
                    if (typeof val === 'string') {
                        return `週${days[dayIndex]} ${val}`;
                    }
                    const s = val?.start || '--:--';
                    const e = val?.end || '--:--';
                    return `週${days[dayIndex]} ${s} - ${e}`;
                })
                .join(', ');
        }

        // 24-hour formatting helpers
        function pad2(n){ return String(n).padStart(2,'0'); }
        function formatDateTime24(date){
            const y = date.getFullYear();
            const m = pad2(date.getMonth()+1);
            const d = pad2(date.getDate());
            const hh = pad2(date.getHours());
            const mm = pad2(date.getMinutes());
            const ss = pad2(date.getSeconds());
            return `${y}-${m}-${d} ${hh}:${mm}:${ss}`;
        }
        function formatTime24(date){
            return `${pad2(date.getHours())}:${pad2(date.getMinutes())}`;
        }


        function renderSchedules(schedules) {
             schedulesList.innerHTML = '';
             if(schedules.length === 0) {
                schedulesList.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">無符合條件的排程</td></tr>`;
                return;
             }
             schedules.forEach(s => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                const patrolPointsCount = s.patrolPoints ? s.patrolPoints.length : 0;
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium text-gray-900">${s.communityName}</td>
                    <td class="px-4 py-3">${s.patrolCode}</td>
                    <td class="px-4 py-3">
                        <button class="manage-points-btn text-blue-600 hover:underline" data-id="${s.id}">${patrolPointsCount} 個</button>
                    </td>
                    <td class="px-4 py-3 text-xs">${formatWeeklyTimes(s.weeklyTimes)}</td>
                    <td class="px-4 py-3">${s.userName}</td>
                    <td class="px-4 py-3 text-right">
                        <button class="copy-schedule-btn font-medium text-green-600 hover:underline mr-2" data-id="${s.id}">複製</button>
                        <button class="edit-schedule-btn font-medium text-blue-600 hover:underline mr-2" data-id="${s.id}">編輯</button>
                        <button class="delete-schedule-btn font-medium text-red-600 hover:underline" data-id="${s.id}">刪除</button>
                    </td>
                `;
                 schedulesList.appendChild(row);
             });
        }
        
        async function saveSchedule() {
            const communitySelect = document.getElementById('schedule-community');
            const communityId = communitySelect.value;
            const communityName = communitySelect.options[communitySelect.selectedIndex].dataset.name;
            
            const userSelect = document.getElementById('schedule-user');
            const userId = userSelect.value;
            const userName = userSelect.options[userSelect.selectedIndex].dataset.name;

            const patrolCode = document.getElementById('schedule-patrol-code').value;
            
            const weeklyTimes = {};
            const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            days.forEach((day, index) => {
                const checkbox = document.getElementById(`schedule-day-${index}`);
                if (checkbox.checked) {
                    const startInput = document.getElementById(`schedule-start-${index}`);
                    const endInput = document.getElementById(`schedule-end-${index}`);
                    const startVal = startInput.value;
                    const endVal = endInput.value;
                    if (startVal || endVal) {
                        weeklyTimes[index] = { start: startVal || '', end: endVal || '' };
                    }
                }
            });

            if (!communityId || !patrolCode || !userId || Object.keys(weeklyTimes).length === 0) {
                alert("請填寫社區、巡邏編號、人員並至少設定一個巡邏時間。");
                return;
            }

            const data = { communityId, communityName, patrolCode, weeklyTimes, userId, userName };

            try {
                 if (editingScheduleId) {
                    const existingDocSnap = await getDoc(doc(db, "schedules", editingScheduleId));
                    const existingData = existingDocSnap.data();
                    data.patrolPoints = existingData.patrolPoints || [];
                    await setDoc(doc(db, "schedules", editingScheduleId), data);
                } else {
                    data.patrolPoints = currentScheduleForPoints ? currentScheduleForPoints.patrolPoints : []; 
                    await addDoc(collection(db, "schedules"), data);
                }
                closeModal(scheduleModal);
            } catch (e) {
                console.error("儲存排程失敗: ", e);
                alert("儲存失敗");
            }
        }
        
        function renderPatrolPoints(schedule) {
            const listEl = document.getElementById('patrol-points-list');
            listEl.innerHTML = '';
            document.getElementById('patrol-points-modal-title').textContent = `管理巡邏點`;
            document.getElementById('patrol-points-schedule-info').textContent = `社區: ${schedule.communityName} | 巡邏編號: ${schedule.patrolCode}`;
            
            if (!schedule.patrolPoints || schedule.patrolPoints.length === 0) {
                listEl.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-gray-500">尚無巡邏點</td></tr>`;
                return;
            }
            schedule.patrolPoints.forEach((p, idx) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                row.innerHTML = `
                    <td class="px-4 py-2">${p.code}</td>
                    <td class="px-4 py-2">${p.name}</td>
                    <td class="px-4 py-2 text-xs">${p.location}</td>
                    <td class="px-4 py-2 text-xs">${p.desc || ''}</td>
                    <td class="px-4 py-2">${p.requiresConfirm ? '是' : '否'}</td>
                    <td class="px-4 py-2 font-mono text-xs">${p.nfcCode}</td>
                    <td class="px-4 py-2 text-right">
                        <button class="move-up-point-btn text-gray-600 hover:underline mr-2" data-id="${p.internalId}" ${idx===0 ? 'disabled' : ''}>上移</button>
                        <button class="move-down-point-btn text-gray-600 hover:underline mr-2" data-id="${p.internalId}" ${idx===schedule.patrolPoints.length-1 ? 'disabled' : ''}>下移</button>
                        <button class="edit-point-btn font-medium text-blue-600 hover:underline mr-2" data-id="${p.internalId}">編輯</button>
                        <button class="delete-point-btn font-medium text-red-600 hover:underline" data-id="${p.internalId}">刪除</button>
                    </td>
                `;
                listEl.appendChild(row);
            });
        }
        
        async function savePatrolPoint() {
            const form = document.getElementById('patrol-point-form');
            const internalId = form.querySelector('#patrol-point-internal-id').value;
            
            const newPoint = {
                internalId: internalId || crypto.randomUUID(),
                code: form.querySelector('#patrol-point-code').value,
                location: form.querySelector('#patrol-point-location').value,
                name: form.querySelector('#patrol-point-name').value,
                nfcCode: form.querySelector('#patrol-point-nfc-code').value,
                desc: form.querySelector('#patrol-point-desc')?.value || '',
                requiresConfirm: !!form.querySelector('#patrol-point-requires-confirm')?.checked,
            };

            if (!newPoint.code || !newPoint.location || !newPoint.name || !newPoint.nfcCode) {
                alert('請填寫巡邏點的所有欄位');
                return;
            }

            const scheduleRef = doc(db, 'schedules', currentScheduleForPoints.id);
            let updatedPoints = [...(currentScheduleForPoints.patrolPoints || [])];

            const existingPointIndex = updatedPoints.findIndex(p => p.internalId === newPoint.internalId);
            if (existingPointIndex > -1) {
                updatedPoints[existingPointIndex] = newPoint; // Update
            } else {
                updatedPoints.push(newPoint); // Add
            }

            try {
                await updateDoc(scheduleRef, { patrolPoints: updatedPoints });
                const updatedScheduleSnap = await getDoc(scheduleRef);
                currentScheduleForPoints = { id: updatedScheduleSnap.id, ...updatedScheduleSnap.data() };
                renderPatrolPoints(currentScheduleForPoints);
                form.reset();
                document.getElementById('patrol-point-form-title').textContent = '新增巡邏點';
                document.getElementById('cancel-edit-point-btn').classList.add('hidden');
            } catch (error) {
                console.error('儲存巡邏點失敗:', error);
                alert('儲存巡邏點失敗');
            }
        }
        
        // --- 巡邏頁面 ---
        // --- 巡邏月曆與依選定日期渲染 ---
        let calendarState = { year: null, month: null, selectedDate: null };
        function setSelectedDate(date) {
            calendarState.selectedDate = date;
            const title = document.getElementById('selected-date-title');
            const isToday = isSameDate(date, new Date());
            title.textContent = isToday ? '今日巡邏任務' : `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')} 巡邏任務`;
            renderPatrolsForDate(date);
        }

        function isSameDate(a, b) {
            return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
        }

        function buildCalendar(year, month) {
            const label = document.getElementById('cal-month-label');
            label.textContent = `${year}年 ${month+1}月`;
            const daysContainer = document.getElementById('patrol-calendar-days');
            daysContainer.innerHTML = '';

            const firstDay = new Date(year, month, 1);
            const startWeekday = firstDay.getDay();
            const daysInMonth = new Date(year, month+1, 0).getDate();

            // 前置空白格
            for (let i=0; i<startWeekday; i++) {
                const empty = document.createElement('div');
                empty.className = 'h-10';
                daysContainer.appendChild(empty);
            }

            for (let d=1; d<=daysInMonth; d++) {
                const date = new Date(year, month, d);
                const btn = document.createElement('button');
                btn.className = 'h-10 rounded border text-sm hover:bg-gray-50';
                btn.textContent = String(d);
                if (isSameDate(date, new Date())) {
                    btn.className += ' bg-red-100 border-red-300 text-red-700 font-semibold';
                }
                btn.addEventListener('click', () => {
                    setSelectedDate(date);
                    // 高亮選中日期
                    Array.from(daysContainer.querySelectorAll('button')).forEach(b => b.classList.remove('ring-2','ring-red-400'));
                    btn.classList.add('ring-2','ring-red-400');
                });
                daysContainer.appendChild(btn);
            }
        }

        async function renderPatrolsForDate(date) {
            todaysPatrolsList.innerHTML = '<p class="text-gray-500">正在載入任務...</p>';
            if (!currentUser) return;

            const weekday = date.getDay();
            const q = query(collection(db, "schedules"), where("userId", "==", currentUser.uid));
            const querySnapshot = await getDocs(q);

            const tasks = [];
            querySnapshot.forEach(doc => {
                const schedule = { id: doc.id, ...doc.data() };
                if (schedule.weeklyTimes && schedule.weeklyTimes[weekday]) {
                    tasks.push(schedule);
                }
            });

            if (tasks.length === 0) {
                 todaysPatrolsList.innerHTML = '<p class="text-gray-500">該日無排定巡邏任務。</p>';
                 return;
            }

            todaysPatrolsList.innerHTML = '';
            tasks.forEach(task => {
                const card = document.createElement('div');
                card.className = 'p-4 bg-white rounded-lg shadow border border-gray-200';
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold text-lg text-gray-800">${task.communityName}</p>
                            <p class="text-sm text-gray-500">${task.patrolCode}</p>
                        </div>
                        <div class="text-right">
                             <p class="font-semibold text-red-600">${(() => {
                                const val = task.weeklyTimes[weekday];
                                if (typeof val === 'string') return val;
                                const s = val?.start || '--:--';
                                const e = val?.end || '--:--';
                                return `${s} - ${e}`;
                             })()}</p>
                             <button class="start-patrol-btn mt-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">開始巡邏</button>
                        </div>
                    </div>
                `;
                card.querySelector('.start-patrol-btn').addEventListener('click', () => {
                    activePatrol = task;
                    document.getElementById('patrol-map-title').textContent = `巡邏地圖: ${task.patrolCode}`;
                    initializePatrolMap(task);
                });
                todaysPatrolsList.appendChild(card);
            });
        }
        
        // --- 資料頁面 ---
        async function loadAndRenderDataPage() {
            dataLogsContainer.innerHTML = '<p class="text-gray-500">正在載入紀錄...</p>';
            if (!userProfile) return;

            const selectedDateStr = document.getElementById('data-filter-date').value;
            if (!selectedDateStr) {
                dataLogsContainer.innerHTML = '<p class="text-red-500">請選擇一個日期進行查詢。</p>';
                return;
            }

            const selectedDate = new Date(selectedDateStr);
            const startOfDay = new Date(selectedDate.setHours(0, 0, 0, 0));
            const endOfDay = new Date(selectedDate.setHours(23, 59, 59, 999));
            const selectedDayIndex = selectedDate.getDay();

            // Tab state & visibility
            const isMonthly = document.getElementById('tab-monthly') && document.getElementById('tab-monthly').classList.contains('bg-red-500');
            document.getElementById('data-logs-container').classList.toggle('hidden', !!isMonthly);
            const monthlyEl = document.getElementById('data-monthly-container');
            if (monthlyEl) monthlyEl.classList.toggle('hidden', !isMonthly);

            // 1. Get relevant schedules for the selected period
            let scheduleConstraints = [];
            const communityFilterId = document.getElementById('data-filter-community').value;

            switch (userProfile.role) {
                case ROLES.GUARD:
                    scheduleConstraints.push(where("userId", "==", currentUser.uid));
                    break;
                case ROLES.CHIEF:
                    if (userProfile.communityId) {
                        scheduleConstraints.push(where("communityId", "==", userProfile.communityId));
                    } else {
                        dataLogsContainer.innerHTML = '<p class="text-red-500">錯誤：總幹事帳號未設定所屬社區。</p>';
                        return;
                    }
                    break;
                case ROLES.ADMIN:
                case ROLES.EXECUTIVE:
                    if (communityFilterId) {
                        scheduleConstraints.push(where("communityId", "==", communityFilterId));
                    }
                    break;
                default:
                    dataLogsContainer.innerHTML = '';
                    return;
            }

            const schedulesQuery = query(collection(db, "schedules"), ...scheduleConstraints);
            const schedulesSnapshot = await getDocs(schedulesQuery);
            
            const relevantSchedules = [];
            schedulesSnapshot.forEach(doc => {
                const schedule = { id: doc.id, ...doc.data() };
                if (!isMonthly && schedule.weeklyTimes && schedule.weeklyTimes[selectedDayIndex]) {
                    relevantSchedules.push(schedule);
                }
            });

            if (!isMonthly && relevantSchedules.length === 0) {
                dataLogsContainer.innerHTML = `<p class="text-gray-500">在 ${selectedDateStr} 無相關巡邏排程。</p>`;
                return;
            }
            
            // 2. Get logs for the selected period, respecting role/community filters
            const logConstraints = [];
            if (!isMonthly) {
                logConstraints.push(where("timestamp", ">=", Timestamp.fromDate(startOfDay)));
                logConstraints.push(where("timestamp", "<=", Timestamp.fromDate(endOfDay)));
            } else {
                const monthStart = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
                const monthEnd = new Date(selectedDate.getFullYear(), selectedDate.getMonth()+1, 0, 23, 59, 59, 999);
                logConstraints.push(where("timestamp", ">=", Timestamp.fromDate(monthStart)));
                logConstraints.push(where("timestamp", "<=", Timestamp.fromDate(monthEnd)));
            }

            // Apply role/community restrictions for logs
            switch (userProfile.role) {
                case ROLES.GUARD:
                    logConstraints.push(where("userId", "==", currentUser.uid));
                    break;
                case ROLES.CHIEF:
                    if (userProfile.communityId) {
                        logConstraints.push(where("communityId", "==", userProfile.communityId));
                    }
                    break;
                case ROLES.ADMIN:
                case ROLES.EXECUTIVE:
                    if (communityFilterId) {
                        logConstraints.push(where("communityId", "==", communityFilterId));
                    }
                    break;
                default:
                    // No logs for unknown role
                    dataLogsContainer.innerHTML = '';
                    return;
            }

            const logsQuery = query(collection(db, "patrol_logs"), ...logConstraints);
            const logsSnapshot = await getDocs(logsQuery);
            const selectedDayLogs = [];
            logsSnapshot.forEach(doc => {
                selectedDayLogs.push({ id: doc.id, ...doc.data() });
            });

            if (!isMonthly) {
                // 3. Group logs by scheduleId
                const logsBySchedule = selectedDayLogs.reduce((acc, log) => {
                    const scheduleId = log.scheduleId;
                    if (!acc[scheduleId]) {
                        acc[scheduleId] = [];
                    }
                    acc[scheduleId].push(log);
                    return acc;
                }, {});

                // 4. Render schedule blocks
                dataLogsContainer.innerHTML = '';
                relevantSchedules.forEach(schedule => {
                    const logsForThisSchedule = logsBySchedule[schedule.id] || [];
                    const totalPoints = schedule.patrolPoints?.length || 0;
                    const completedPoints = new Set(logsForThisSchedule.map(l => l.patrolPointId)).size;

                    const card = document.createElement('div');
                    card.className = 'p-4 bg-white rounded-lg shadow border border-gray-200 cursor-pointer hover:bg-gray-50';
                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-lg text-gray-800">${schedule.communityName}</p>
                                <p class="text-sm text-gray-500">${schedule.patrolCode} (${schedule.userName})</p>
                            </div>
                            <div class="text-right">
                             <p class="font-semibold text-lg">${completedPoints} / ${totalPoints}</p>
                             <p class="text-xs text-gray-500">已完成/總數</p>
                            </div>
                        </div>
                    `;
                    card.addEventListener('click', () => {
                        renderLogDetailsModal(schedule, logsForThisSchedule);
                    });
                    dataLogsContainer.appendChild(card);
                });
            } else {
                // Monthly aggregation to table
                const month = new Date(selectedDateStr);
                const daysInMonth = new Date(month.getFullYear(), month.getMonth()+1, 0).getDate();
                const countsByDay = Array(daysInMonth).fill(0);
                selectedDayLogs.forEach(log => {
                    const dt = log.timestamp && log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp);
                    countsByDay[dt.getDate()-1]++;
                });
                const monthlyContainer = document.getElementById('data-monthly-container');
                if (monthlyContainer) {
                    monthlyContainer.innerHTML = '';
                    const table = document.createElement('table');
                    table.className = 'min-w-full divide-y divide-gray-200';
                    table.innerHTML = `
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-700">日期</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-700">紀錄筆數</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200"></tbody>
                    `;
                    const tbody = table.querySelector('tbody');
                    for (let d = 1; d <= daysInMonth; d++) {
                        const tr = document.createElement('tr');
                        tr.classList.add('hover:bg-gray-50','cursor-pointer');
                        const dateStr = `${month.getFullYear()}-${String(month.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                        tr.innerHTML = `
                            <td class="px-4 py-2">${dateStr}</td>
                            <td class="px-4 py-2">${countsByDay[d-1]}</td>
                        `;
                        tr.addEventListener('click', () => {
                            const dateInput = document.getElementById('data-filter-date');
                            if (dateInput) dateInput.value = dateStr;
                            const dailyBtn = document.getElementById('tab-daily');
                            if (dailyBtn) dailyBtn.click();
                        });
                        tbody.appendChild(tr);
                    }
                    monthlyContainer.appendChild(table);
                }
            }
        }

        // Tabs interactions
        document.addEventListener('click', (e) => {
            if (e.target.id === 'tab-daily' || e.target.id === 'tab-monthly') {
                const dailyBtn = document.getElementById('tab-daily');
                const monthlyBtn = document.getElementById('tab-monthly');
                const makeActive = (btn, active) => {
                    btn.classList.toggle('bg-red-500', active);
                    btn.classList.toggle('text-white', active);
                    btn.classList.toggle('bg-gray-200', !active);
                    btn.classList.toggle('text-gray-700', !active);
                };
                const isMonthly = e.target.id === 'tab-monthly';
                makeActive(dailyBtn, !isMonthly);
                makeActive(monthlyBtn, isMonthly);
                loadAndRenderDataPage();
            }
        });

        function renderLogDetailsModal(schedule, logs) {
            const modalTitle = document.getElementById('log-details-modal-title');
            const detailsList = document.getElementById('log-details-list');
            const isAdmin = [ROLES.ADMIN, ROLES.EXECUTIVE].includes(userProfile.role);
            const actionsHeader = document.getElementById('log-actions-header');
            if (actionsHeader) {
                actionsHeader.style.display = isAdmin ? 'table-cell' : 'none';
            }
            
            modalTitle.textContent = `巡邏紀錄: ${schedule.communityName} - ${schedule.patrolCode}`;
            detailsList.innerHTML = '';

            const allPoints = schedule.patrolPoints || [];
            if (allPoints.length === 0) {
                 detailsList.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">此排程未設定任何巡邏點。</td></tr>';
                 openModal(logDetailsModal);
                 return;
            }
            
            allPoints.forEach(point => {
                const log = logs.find(l => l.patrolPointId === point.internalId);
                const row = document.createElement('tr');
                row.dataset.scheduleId = schedule.id;
                row.dataset.pointId = point.internalId;
                const isCompleted = !!log;
                
                let statusText = '異常';
                let statusColor = 'bg-red-200 text-red-800';
                let rowColor = 'bg-red-50';

                if (isCompleted) {
                    const distance = calculateDistance(point.location, log.scanLocation);
                    if (distance <= 20) {
                        statusText = '正常';
                        statusColor = 'bg-green-200 text-green-800';
                        rowColor = 'bg-green-50';
                    } else {
                        statusText = `異常 (距離 ${distance.toFixed(0)}m)`;
                    }
                }

                row.className = rowColor;
                
                const locationButton = `<button class="show-map-preview-btn text-blue-600 hover:underline" data-point-location="${point.location || ''}" data-scan-location="${log?.scanLocation || ''}">${point.location || 'N/A'}</button>`;
                
                let actionsHtml = '';
                if (isAdmin) {
                    if (isCompleted) {
                        actionsHtml = `
                            <button class="edit-log-btn text-blue-600 hover:underline text-xs" data-log-id="${log.id}">編輯</button>
                            <button class="delete-log-btn text-red-600 hover:underline text-xs ml-2" data-log-id="${log.id}">刪除</button>
                        `;
                    } else {
                        actionsHtml = `<button class="add-log-btn text-green-600 hover:underline text-xs">補登</button>`;
                    }
                }

                row.innerHTML = `
                    <td class="px-4 py-3">${schedule.communityName}</td>
                    <td class="px-4 py-3">${schedule.userName}</td>
                    <td class="px-4 py-3">${point.code} (${point.name})</td>
                    <td class="px-4 py-3 text-xs">${locationButton}</td>
                    <td class="px-4 py-3">${isCompleted ? formatDateTime24(log.timestamp.toDate()) : '--'}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-right print-hide">${actionsHtml}</td>
                `;
                detailsList.appendChild(row);
            });

            openModal(logDetailsModal);
        }

        // --- Event Listeners for Page Actions ---
        document.addEventListener('click', async (e) => {
            // Community Modals & Actions
            if (e.target.id === 'add-community-btn') {
                editingCommunityId = null;
                document.getElementById('community-modal-title').textContent = '新增社區';
                document.getElementById('community-form').reset();
                openModal(communityModal);
            }
            if (e.target.id === 'close-community-modal-btn') closeModal(communityModal);
            if (e.target.id === 'save-community-btn') saveCommunity();
            if (e.target.classList.contains('edit-community-btn')) {
                editingCommunityId = e.target.dataset.id;
                const communityRef = doc(db, "communities", editingCommunityId);
                const communitySnap = await getDoc(communityRef);
                if (communitySnap.exists()) {
                    const data = communitySnap.data();
                    document.getElementById('community-modal-title').textContent = '編輯社區';
                    document.getElementById('community-code').value = data.code;
                    document.getElementById('community-name').value = data.name;
                    document.getElementById('community-gps').value = data.gps || '';
                    openModal(communityModal);
                }
            }
            if (e.target.classList.contains('delete-community-btn')) {
                if (confirm('確定要刪除此社區嗎？')) {
                    await deleteDoc(doc(db, "communities", e.target.dataset.id));
                }
            }

            // User Modals & Actions
            if (e.target.id === 'add-user-btn') {
                editingUserId = null;
                document.getElementById('user-modal-title').textContent = '新增帳號';
                document.getElementById('user-form').reset();
                document.getElementById('user-email').disabled = false;
                document.getElementById('password-container').classList.remove('hidden');
                document.getElementById('password-help-text').textContent = '新增帳號時為必填 (至少6個字元)。';
                populateSelect(document.getElementById('user-community'), await getOptionsForSelect('communities', 'name'), '選擇社區');
                document.getElementById('user-community-container').classList.add('hidden');
                openModal(userModal);
            }
            if (e.target.id === 'close-user-modal-btn') closeModal(userModal);
            if (e.target.id === 'save-user-btn') saveUser();
             if (e.target.classList.contains('edit-user-btn')) {
                editingUserId = e.target.dataset.id;
                const userRef = doc(db, "users", editingUserId);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    const data = userSnap.data();
                    document.getElementById('user-modal-title').textContent = '編輯帳號';
                    document.getElementById('user-role').value = data.role;
                    document.getElementById('user-name').value = data.name;
                    document.getElementById('user-email').value = data.email;
                    document.getElementById('user-email').disabled = true;
                    document.getElementById('password-container').classList.add('hidden');
                    document.getElementById('user-password').value = '';
                    
                    const communitySelect = document.getElementById('user-community');
                    await populateSelect(communitySelect, await getOptionsForSelect('communities', 'name'), '選擇社區');
                    if (data.role === ROLES.CHIEF) {
                        document.getElementById('user-community-container').classList.remove('hidden');
                        communitySelect.value = data.communityId || '';
                    } else {
                        document.getElementById('user-community-container').classList.add('hidden');
                    }
                    openModal(userModal);
                }
            }
            if (e.target.classList.contains('delete-user-btn')) {
                 if (confirm('確定要刪除此帳號嗎？(此操作僅刪除資料庫紀錄)')) {
                    await deleteDoc(doc(db, "users", e.target.dataset.id));
                }
            }
            
            // Schedule Modals & Actions
            if (e.target.id === 'add-schedule-btn' || e.target.classList.contains('copy-schedule-btn')) {
                const isCopy = e.target.classList.contains('copy-schedule-btn');
                let sourceData = null;

                if (isCopy) {
                    const scheduleId = e.target.dataset.id;
                    const scheduleSnap = await getDoc(doc(db, "schedules", scheduleId));
                    if(scheduleSnap.exists()) sourceData = scheduleSnap.data();
                    editingScheduleId = null; 
                    currentScheduleForPoints = sourceData; 
                    document.getElementById('schedule-modal-title').textContent = '複製排程';
                } else {
                    editingScheduleId = null;
                    currentScheduleForPoints = null; 
                    document.getElementById('schedule-modal-title').textContent = '新增排程';
                }
                
                document.getElementById('schedule-form').reset();
                 document.querySelectorAll('#weekly-times-container input[type="checkbox"]').forEach((cb, index) => {
                    cb.checked = false;
                    const startInput = document.getElementById(`schedule-start-${index}`);
                    const endInput = document.getElementById(`schedule-end-${index}`);
                    startInput.disabled = true; startInput.value = '';
                    endInput.disabled = true; endInput.value = '';
                 });

                
                const [communities, staff] = await Promise.all([
                    getOptionsForSelect('communities', 'name'),
                    getPatrolStaffForSelect()
                ]);
                populateSelect(document.getElementById('schedule-community'), communities, '選擇社區');
                populateSelect(document.getElementById('schedule-user'), staff, '選擇人員');

                if (sourceData) {
                    document.getElementById('schedule-community').value = sourceData.communityId || '';
                    document.getElementById('schedule-user').value = sourceData.userId || '';
                    document.getElementById('schedule-patrol-code').value = `${sourceData.patrolCode}-副本`;
                    if (sourceData.weeklyTimes) {
                         Object.entries(sourceData.weeklyTimes).forEach(([dayIndex, val]) => {
                             const checkbox = document.getElementById(`schedule-day-${dayIndex}`);
                             const startInput = document.getElementById(`schedule-start-${dayIndex}`);
                             const endInput = document.getElementById(`schedule-end-${dayIndex}`);
                             if (checkbox && startInput && endInput) {
                                checkbox.checked = true;
                                if (typeof val === 'string') {
                                    startInput.value = val; endInput.value = '';
                                } else {
                                    startInput.value = val.start || '';
                                    endInput.value = val.end || '';
                                }
                                startInput.disabled = false;
                                endInput.disabled = false;
                             }
                         });
                    }
                }
                
                openModal(scheduleModal);
            }
            if (e.target.id === 'close-schedule-modal-btn') closeModal(scheduleModal);
            if (e.target.id === 'save-schedule-btn') saveSchedule();
            if (e.target.classList.contains('edit-schedule-btn')) {
                 editingScheduleId = e.target.dataset.id;
                 const scheduleRef = doc(db, "schedules", editingScheduleId);
                 const scheduleSnap = await getDoc(scheduleRef);
                 if (scheduleSnap.exists()) {
                     const data = scheduleSnap.data();
                     document.getElementById('schedule-modal-title').textContent = '編輯排程';
                     
                     const [communities, staff] = await Promise.all([
                        getOptionsForSelect('communities', 'name'),
                        getPatrolStaffForSelect()
                     ]);
                     populateSelect(document.getElementById('schedule-community'), communities, '選擇社區');
                     populateSelect(document.getElementById('schedule-user'), staff, '選擇人員');

                     document.getElementById('schedule-community').value = data.communityId;
                     document.getElementById('schedule-user').value = data.userId;
                     document.getElementById('schedule-patrol-code').value = data.patrolCode;
                     
                     document.querySelectorAll('#weekly-times-container input[type="checkbox"]').forEach((cb, index) => {
                        cb.checked = false;
                        const startInput = document.getElementById(`schedule-start-${index}`);
                        const endInput = document.getElementById(`schedule-end-${index}`);
                        startInput.disabled = true; startInput.value = '';
                        endInput.disabled = true; endInput.value = '';
                     });
                     
                     if (data.weeklyTimes) {
                         Object.entries(data.weeklyTimes).forEach(([dayIndex, val]) => {
                             const checkbox = document.getElementById(`schedule-day-${dayIndex}`);
                             const startInput = document.getElementById(`schedule-start-${dayIndex}`);
                             const endInput = document.getElementById(`schedule-end-${dayIndex}`);
                             if (checkbox && startInput && endInput) {
                                checkbox.checked = true;
                                if (typeof val === 'string') {
                                    startInput.value = val; endInput.value = '';
                                } else {
                                    startInput.value = val.start || '';
                                    endInput.value = val.end || '';
                                }
                                startInput.disabled = false;
                                endInput.disabled = false;
                             }
                         });
                     }
                     openModal(scheduleModal);
                 }
            }
            if (e.target.classList.contains('delete-schedule-btn')) {
                if(confirm('確定要刪除此排程嗎？')) {
                    await deleteDoc(doc(db, "schedules", e.target.dataset.id));
                }
            }

            // Patrol Points Modal
            if(e.target.classList.contains('manage-points-btn')) {
                const scheduleId = e.target.dataset.id;
                const scheduleRef = doc(db, 'schedules', scheduleId);
                const scheduleSnap = await getDoc(scheduleRef);
                if (scheduleSnap.exists()) {
                    currentScheduleForPoints = { id: scheduleSnap.id, ...scheduleSnap.data() };
                    renderPatrolPoints(currentScheduleForPoints);
                    openModal(patrolPointsModal);
                }
            }
            if(e.target.id === 'close-patrol-points-modal-btn') closeModal(patrolPointsModal);
            if(e.target.id === 'save-patrol-point-btn') savePatrolPoint();
            if(e.target.id === 'generate-nfc-code-btn') {
                document.getElementById('patrol-point-nfc-code').value = generateAlphanumericCode(16);
            }
            if (e.target.classList.contains('edit-point-btn')) {
                const pointId = e.target.dataset.id;
                const point = currentScheduleForPoints.patrolPoints.find(p => p.internalId === pointId);
                if (point) {
                    const form = document.getElementById('patrol-point-form');
                    form.querySelector('#patrol-point-internal-id').value = point.internalId;
                    form.querySelector('#patrol-point-code').value = point.code;
                    form.querySelector('#patrol-point-location').value = point.location;
                    form.querySelector('#patrol-point-name').value = point.name;
                    form.querySelector('#patrol-point-nfc-code').value = point.nfcCode;
                    const descEl = form.querySelector('#patrol-point-desc');
                    const confirmEl = form.querySelector('#patrol-point-requires-confirm');
                    if (descEl) descEl.value = point.desc || '';
                    if (confirmEl) confirmEl.checked = !!point.requiresConfirm;
                    document.getElementById('patrol-point-form-title').textContent = '編輯巡邏點';
                    document.getElementById('cancel-edit-point-btn').classList.remove('hidden');
                }
            }
            if (e.target.id === 'cancel-edit-point-btn') {
                document.getElementById('patrol-point-form').reset();
                document.getElementById('patrol-point-form-title').textContent = '新增巡邏點';
                e.target.classList.add('hidden');
            }
            if(e.target.classList.contains('delete-point-btn')) {
                if(confirm('確定要刪除此巡邏點嗎？')) {
                    const pointIdToDelete = e.target.dataset.id;
                    const updatedPoints = currentScheduleForPoints.patrolPoints.filter(p => p.internalId !== pointIdToDelete);
                    const scheduleRef = doc(db, 'schedules', currentScheduleForPoints.id);
                    await updateDoc(scheduleRef, { patrolPoints: updatedPoints });
                    currentScheduleForPoints.patrolPoints = updatedPoints;
                    renderPatrolPoints(currentScheduleForPoints);
                }
            }

            // Reorder patrol points
            if (e.target.classList.contains('move-up-point-btn') || e.target.classList.contains('move-down-point-btn')) {
                const id = e.target.dataset.id;
                const points = [...(currentScheduleForPoints.patrolPoints || [])];
                const idx = points.findIndex(p => p.internalId === id);
                if (idx === -1) return;
                const isUp = e.target.classList.contains('move-up-point-btn');
                const swapIdx = isUp ? idx - 1 : idx + 1;
                if (swapIdx < 0 || swapIdx >= points.length) return;
                [points[idx], points[swapIdx]] = [points[swapIdx], points[idx]];
                const scheduleRef = doc(db, 'schedules', currentScheduleForPoints.id);
                await updateDoc(scheduleRef, { patrolPoints: points });
                currentScheduleForPoints.patrolPoints = points;
                renderPatrolPoints(currentScheduleForPoints);
            }
            
            // GPS Buttons
            if (e.target.closest('.get-gps-btn')) {
                const targetId = e.target.closest('.get-gps-btn').dataset.target;
                initializeMapForSelection(targetId);
            }

            // Log Details Modal & Manual Log Modal
            if (e.target.id === 'close-log-details-modal-btn') closeModal(logDetailsModal);
            if (e.target.id === 'close-manual-log-modal-btn') closeModal(manualLogModal);
            if (e.target.id === 'save-manual-log-btn') await saveManualLog();
            if (e.target.classList.contains('show-map-preview-btn')) {
                const pointLoc = e.target.dataset.pointLocation;
                const scanLoc = e.target.dataset.scanLocation;
                showMapPreview(pointLoc, scanLoc);
            }
            if (e.target.classList.contains('add-log-btn') || e.target.classList.contains('edit-log-btn')) {
                const isEdit = e.target.classList.contains('edit-log-btn');
                const scheduleId = e.target.closest('tr').dataset.scheduleId;
                const pointId = e.target.closest('tr').dataset.pointId;
                const logId = isEdit ? e.target.dataset.logId : null;
                await openManualLogModal(scheduleId, pointId, logId);
            }
            if (e.target.classList.contains('delete-log-btn')) {
                const logId = e.target.dataset.logId;
                if (confirm('確定要刪除這筆紀錄嗎？')) {
                    await deleteDoc(doc(db, 'patrol_logs', logId));
                    loadAndRenderDataPage(); // Refresh data page
                    closeModal(logDetailsModal);
                }
            }

        });

        // Event listeners for filters
        document.getElementById('data-apply-filters-btn').addEventListener('click', loadAndRenderDataPage);
        document.getElementById('filter-community').addEventListener('change', listenForSchedules);
        document.getElementById('filter-user').addEventListener('change', listenForSchedules);
        document.getElementById('clear-filters-btn').addEventListener('click', () => {
            document.getElementById('filter-community').value = '';
            document.getElementById('filter-user').value = '';
            listenForSchedules();
        });
        
        // Map Modal Listeners
        document.getElementById('confirm-map-selection-btn').addEventListener('click', () => {
            if (currentGpsTargetInput && marker) {
                const latLng = marker.getLatLng();
                currentGpsTargetInput.value = `${latLng.lat.toFixed(6)}, ${latLng.lng.toFixed(6)}`;
            }
            closeModal(mapModal);
        });
        document.getElementById('close-map-modal-btn').addEventListener('click', () => closeModal(mapModal));
        document.getElementById('close-map-preview-modal-btn').addEventListener('click', () => closeModal(mapPreviewModal));
        document.getElementById('close-patrol-map-btn').addEventListener('click', () => {
            // 僅關閉地圖彈窗，不清空底部巡邏點列表，避免在移動端被隱藏
            closeModal(patrolMapModal);
        });
        document.getElementById('close-nfc-scan-modal-btn').addEventListener('click', () => closeModal(nfcPointScanModal));
        document.getElementById('print-log-btn').addEventListener('click', () => {
            const table = document.getElementById('log-details-table');
            const tbody = document.getElementById('log-details-list');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            // 建立列印容器
            const printContent = document.getElementById('print-area').cloneNode(true);
            const wrapper = document.getElementById('print-content-wrapper');
            wrapper.innerHTML = '';

            // 重建表格：首列為欄位名稱；其後為資料列
            const newTable = document.createElement('table');
            newTable.className = table.className;
            const thead = document.createElement('thead');
            thead.className = table.querySelector('thead').className;
            const headerRow = document.createElement('tr');
            ['社區', '保全', '巡邏點編號', '定位地圖', '感應時間', '狀態'].forEach(text => {
                const th = document.createElement('th');
                th.className = 'px-4 py-2';
                th.textContent = text;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            const newTbody = document.createElement('tbody');

            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('td'));
                // 取前6欄（排除操作欄）
                const dataCells = cells.slice(0, 6).map(td => {
                    const cell = document.createElement('td');
                    cell.className = 'px-4 py-3';
                    // 將定位地圖的按鈕文字改為純座標字串
                    if (td.querySelector('.show-map-preview-btn')) {
                        cell.textContent = td.querySelector('.show-map-preview-btn').textContent || td.textContent;
                    } else {
                        cell.textContent = td.textContent;
                    }
                    return cell;
                });
                const newRow = document.createElement('tr');
                dataCells.forEach(dc => newRow.appendChild(dc));
                newTbody.appendChild(newRow);
            });

            newTable.appendChild(thead);
            newTable.appendChild(newTbody);

            // 替換原本的列表區塊
            const tableContainer = printContent.querySelector('.table-container');
            tableContainer.innerHTML = '';
            tableContainer.appendChild(newTable);

            // 顯示列印標頭與時間
            printContent.querySelector('#print-header').classList.remove('hidden');
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            const ss = String(now.getSeconds()).padStart(2, '0');
            printContent.querySelector('#print-date').textContent = `報告生成時間: ${y}-${m}-${d} ${hh}:${mm}:${ss}`;
            // 隱藏按鈕區塊
            const btnBar = printContent.querySelector('.print-hide');
            if (btnBar) btnBar.classList.add('hidden');

            wrapper.appendChild(printContent);
            window.print();
        });


        // Populate User Role Dropdown and handle visibility of community dropdown
        const userRoleSelect = document.getElementById('user-role');
        Object.values(ROLES).forEach(role => {
            const option = document.createElement('option');
            option.value = role;
            option.textContent = role;
            userRoleSelect.appendChild(option);
        });
        userRoleSelect.addEventListener('change', (e) => {
            const communityContainer = document.getElementById('user-community-container');
            if (e.target.value === ROLES.CHIEF) {
                communityContainer.classList.remove('hidden');
            } else {
                communityContainer.classList.add('hidden');
            }
        });

        // Generate weekly time inputs in schedule modal
        const weeklyTimesContainer = document.getElementById('weekly-times-container');
        const daysOfWeek = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
        daysOfWeek.forEach((day, index) => {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between';
            div.innerHTML = `
                <div class="flex items-center">
                    <input id="schedule-day-${index}" type="checkbox" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                    <label for="schedule-day-${index}" class="ml-3 block text-sm font-medium text-gray-700">${day}</label>
                </div>
                <div class="flex items-center gap-2">
                    <label for="schedule-start-${index}" class="text-xs text-gray-600">開始</label>
                    <input type="time" id="schedule-start-${index}" class="w-28 px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" disabled>
                    <label for="schedule-end-${index}" class="text-xs text-gray-600">結束</label>
                    <input type="time" id="schedule-end-${index}" class="w-28 px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" disabled>
                </div>
            `;
            weeklyTimesContainer.appendChild(div);
            div.querySelector(`#schedule-day-${index}`).addEventListener('change', (e) => {
                div.querySelector(`#schedule-start-${index}`).disabled = !e.target.checked;
                div.querySelector(`#schedule-end-${index}`).disabled = !e.target.checked;
            });
        });


        // --- NFC 功能 ---
        function checkNFCSupport() {
            if ('NDEFReader' in window) {
                nfcStatus.textContent = '支援';
                nfcStatus.className = 'text-green-600';
            } else {
                nfcStatus.textContent = '不支援';
                nfcStatus.className = 'text-red-600';
            }
        }
        
        function scanLogMessage(message) {
            const p = document.createElement('p');
            const time = formatTime24(new Date());
            p.innerHTML = `<span class="font-mono text-gray-400">[${time}]</span> ${message}`;
            nfcScanLog.prepend(p);
        }

        async function startNFCScan(point) {
            scanLogMessage(`準備掃描: ${point.name}...`);
            try {
                const ndef = new NDEFReader();
                await ndef.scan();
                
                ndef.addEventListener("readingerror", () => {
                    scanLogMessage("<span class='text-red-500'>讀取 NFC 標籤失敗。</span>");
                });

                ndef.addEventListener("reading", ({ message, serialNumber }) => {
                    handleScanSuccess(message, serialNumber, point);
                });

            } catch (error) {
                scanLogMessage(`<span class='text-red-500'>掃描錯誤: ${error}</span>`);
            }
        }

        async function handleScanSuccess(message, serialNumber, targetPoint) {
            let recordData = serialNumber;
            if (message && message.records.length > 0) {
                try {
                    const decoder = new TextDecoder();
                    recordData = decoder.decode(message.records[0].data);
                } catch (e) {
                    console.warn("Could not decode NDEF message, falling back to serial number.", e);
                }
            }

            if (targetPoint.nfcCode === recordData) {
                scanLogMessage(`✅ 成功感應！`);
                scanLogMessage("正在獲取GPS位置...");
                getGPSLocation(
                    (coords) => {
                        scanLogMessage(`GPS位置已獲取`);
                        savePatrolLog(targetPoint, new Date(), coords);
                        closeModal(document.getElementById('nfc-point-scan-modal'));
                        updatePatrolMapMarker(targetPoint.internalId, true);
                    },
                    () => { // Error callback
                        scanLogMessage("<span class='text-red-500'>無法獲取GPS位置</span>");
                        savePatrolLog(targetPoint, new Date(), null); // Save without location
                        closeModal(document.getElementById('nfc-point-scan-modal'));
                        updatePatrolMapMarker(targetPoint.internalId, true);
                    }
                );
            } else {
                scanLogMessage(`❌ 標籤不符，請掃描正確的標籤。`);
            }
        }
        
        async function savePatrolLog(patrolPoint, timestamp, scanLocation) {
            if (!currentUser || !activePatrol) {
                scanLogMessage("<span class='text-red-500'>錯誤：無法儲存紀錄。</span>");
                return;
            }
            try {
                const logData = {
                    userId: activePatrol.userId,
                    userName: activePatrol.userName,
                    scheduleId: activePatrol.id,
                    communityId: activePatrol.communityId,
                    communityName: activePatrol.communityName,
                    patrolPointId: patrolPoint.internalId,
                    patrolPointName: patrolPoint.name,
                    patrolPointCode: patrolPoint.code,
                    nfcCode: patrolPoint.nfcCode,
                    timestamp: timestamp,
                    scanLocation: scanLocation || null
                };
                await addDoc(collection(db, "patrol_logs"), logData);
            } catch (error) {
                console.error("寫入 Firestore 失敗: ", error);
                scanLogMessage("<span class='text-red-500'>儲存紀錄至雲端失敗！</span>");
            }
        }
        
        // --- Helper Functions ---
        function generateAlphanumericCode(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function calculateDistance(coords1Str, coords2Str) {
            if (!coords1Str || !coords2Str) return Infinity;
            
            try {
                const [lat1, lon1] = coords1Str.split(',').map(Number);
                const [lat2, lon2] = coords2Str.split(',').map(Number);

                if (isNaN(lat1) || isNaN(lon1) || isNaN(lat2) || isNaN(lon2)) return Infinity;

                const R = 6371e3; // metres
                const φ1 = lat1 * Math.PI/180;
                const φ2 = lat2 * Math.PI/180;
                const Δφ = (lat2-lat1) * Math.PI/180;
                const Δλ = (lon2-lon1) * Math.PI/180;

                const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                        Math.cos(φ1) * Math.cos(φ2) *
                        Math.sin(Δλ/2) * Math.sin(Δλ/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

                return R * c; // in metres
            } catch (e) {
                console.error("Error calculating distance:", e);
                return Infinity;
            }
        }
        
        function getGPSLocation(successCallback, errorCallback) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude.toFixed(6);
                        const lon = position.coords.longitude.toFixed(6);
                        if(successCallback) successCallback(`${lat}, ${lon}`);
                    },
                    (error) => {
                        alert(`無法獲取GPS位置: ${error.message}`);
                        console.error("GPS Error:", error);
                        if (errorCallback) errorCallback(error);
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                alert("您的瀏覽器不支援GPS定位。");
                if (errorCallback) errorCallback(new Error("Geolocation not supported"));
            }
        }

        function initializeMapForSelection(targetInputId) {
            currentGpsTargetInput = document.getElementById(targetInputId);
            openModal(mapModal);

            const raw = currentGpsTargetInput.value || '';
            const parts = raw.split(/\s*,\s*/);
            const initialCoords = parts.map(s => parseFloat(s.trim()));
            let lat = 25.0018; // Default to Zhonghe, New Taipei
            let lng = 121.4975;
            let zoom = 15;

            if (initialCoords.length === 2 && !isNaN(initialCoords[0]) && !isNaN(initialCoords[1])) {
                lat = initialCoords[0];
                lng = initialCoords[1];
                zoom = 18;
            }

            if (!map) {
                map = L.map('map-container').setView([lat, lng], zoom);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(map);
                marker = L.marker([lat, lng], { draggable: true }).addTo(map);
            } else {
                map.setView([lat, lng], zoom);
                marker.setLatLng([lat, lng]);
            }

            // 行動裝置上彈窗動畫影響地圖尺寸，延遲刷新避免灰屏
            setTimeout(() => map.invalidateSize(), 150);

            if (!currentGpsTargetInput.value && navigator.geolocation) {
                 navigator.geolocation.getCurrentPosition(position => {
                     const userLat = position.coords.latitude;
                     const userLng = position.coords.longitude;
                     map.setView([userLat, userLng], 16);
                     marker.setLatLng([userLat, userLng]);
                 }, () => {
                    console.warn("Could not get user's location, using default.");
                 });
            }
        }

        // 手動補登／編輯巡邏紀錄
        async function openManualLogModal(scheduleId, pointId, logId) {
            try {
                const scheduleRef = doc(db, 'schedules', scheduleId);
                const scheduleSnap = await getDoc(scheduleRef);
                if (!scheduleSnap.exists()) {
                    alert('找不到排程資料');
                    return;
                }
                const schedule = { id: scheduleSnap.id, ...scheduleSnap.data() };
                const point = (schedule.patrolPoints || []).find(p => p.internalId === pointId);
                if (!point) {
                    alert('找不到巡邏點資料');
                    return;
                }

                document.getElementById('manual-log-modal-title').textContent = logId ? '編輯巡邏紀錄' : '補登巡邏紀錄';
                document.getElementById('manual-log-id').value = logId || '';
                document.getElementById('manual-log-schedule-id').value = scheduleId;
                document.getElementById('manual-log-point-id').value = pointId;
                document.getElementById('manual-log-point-name').textContent = `${point.code}（${point.name}）`;

                const datetimeInput = document.getElementById('manual-log-datetime');
                const locationInput = document.getElementById('manual-log-location');
                datetimeInput.value = '';
                locationInput.value = '';

                if (logId) {
                    const logRef = doc(db, 'patrol_logs', logId);
                    const logSnap = await getDoc(logRef);
                    if (logSnap.exists()) {
                        const log = logSnap.data();
                        const ts = log.timestamp && log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp);
                        const isoLocal = new Date(ts.getTime() - ts.getTimezoneOffset()*60000).toISOString().slice(0,16);
                        datetimeInput.value = isoLocal;
                        locationInput.value = log.scanLocation || '';
                    }
                } else {
                    const now = new Date();
                    const isoLocal = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().slice(0,16);
                    datetimeInput.value = isoLocal;
                    locationInput.placeholder = point.location || '請點右側GPS鍵或手動輸入 25.0, 121.5';
                }

                openModal(manualLogModal);
            } catch (e) {
                console.error('開啟手動紀錄視窗失敗:', e);
                alert('開啟手動紀錄視窗失敗');
            }
        }

        async function saveManualLog() {
            const logId = document.getElementById('manual-log-id').value;
            const scheduleId = document.getElementById('manual-log-schedule-id').value;
            const pointId = document.getElementById('manual-log-point-id').value;
            const datetimeStr = document.getElementById('manual-log-datetime').value;
            const scanLocation = document.getElementById('manual-log-location').value.trim();

            if (!scheduleId || !pointId || !datetimeStr) {
                alert('請完整填寫必要欄位');
                return;
            }

            if (scanLocation && scanLocation.split(',').map(Number).length !== 2) {
                alert('GPS位置格式需為「緯度, 經度」');
                return;
            }

            try {
                const scheduleRef = doc(db, 'schedules', scheduleId);
                const scheduleSnap = await getDoc(scheduleRef);
                if (!scheduleSnap.exists()) {
                    alert('排程不存在');
                    return;
                }
                const schedule = { id: scheduleSnap.id, ...scheduleSnap.data() };
                const point = (schedule.patrolPoints || []).find(p => p.internalId === pointId);
                if (!point) {
                    alert('巡邏點不存在');
                    return;
                }

                const ts = new Date(datetimeStr);
                const logData = {
                    userId: schedule.userId,
                    userName: schedule.userName,
                    scheduleId: schedule.id,
                    communityId: schedule.communityId,
                    communityName: schedule.communityName,
                    patrolPointId: point.internalId,
                    patrolPointName: point.name,
                    patrolPointCode: point.code,
                    nfcCode: point.nfcCode,
                    timestamp: Timestamp.fromDate(ts),
                    scanLocation: scanLocation || null
                };

                if (logId) {
                    await updateDoc(doc(db, 'patrol_logs', logId), logData);
                } else {
                    await addDoc(collection(db, 'patrol_logs'), logData);
                }

                closeModal(manualLogModal);
                await loadAndRenderDataPage();
            } catch (e) {
                console.error('儲存手動紀錄失敗:', e);
                alert('儲存手動紀錄失敗');
            }
        }

        function showMapPreview(pointLocation, scanLocation) {
            if (!pointLocation) {
                alert("未設定巡邏點的GPS位置。");
                return;
            }

            openModal(mapPreviewModal);

            // 解析座標字串，支援含空白的格式
            const pointCoords = pointLocation.split(',').map(s => Number(s.trim()));
            const bounds = L.latLngBounds([pointCoords]);

            if (!mapPreview) {
                mapPreview = L.map('map-preview-container', { zoomControl: true }).setView(pointCoords, 18);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(mapPreview);
                // 保障初次顯示尺寸正確
                setTimeout(() => mapPreview && mapPreview.invalidateSize(), 150);
            } else {
                if (pointMarker) mapPreview.removeLayer(pointMarker);
                if (scanMarker) mapPreview.removeLayer(scanMarker);
                if (locationCircle) mapPreview.removeLayer(locationCircle);
                // 重設視角
                mapPreview.setView(pointCoords, 18);
            }

            pointMarker = L.marker(pointCoords).addTo(mapPreview)
                .bindPopup('預設巡邏點').openPopup();

            locationCircle = L.circle(pointCoords, {
                color: 'green',
                fillColor: '#8f8',
                fillOpacity: 0.3,
                radius: 20
            }).addTo(mapPreview);

            if (scanLocation) {
                const scanCoords = scanLocation.split(',').map(s => Number(s.trim()));
                if (scanCoords.length === 2 && !isNaN(scanCoords[0])) {
                    scanMarker = L.marker(scanCoords, { 
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                        }) 
                    }).addTo(mapPreview).bindPopup('實際感應位置');
                    bounds.extend(scanCoords);
                }
            }
            
            mapPreview.fitBounds(bounds, { padding: [50, 50] });
            // 兩次尺寸重算，確保容器完全顯示後正確渲染
            setTimeout(() => mapPreview && mapPreview.invalidateSize(), 150);
            setTimeout(() => mapPreview && mapPreview.invalidateSize(), 400);
        }

        // 關閉預覽時清理，避免殘留造成下次顯示異常
        document.getElementById('close-map-preview-modal-btn').addEventListener('click', () => {
            if (mapPreview) {
                if (pointMarker) mapPreview.removeLayer(pointMarker);
                if (scanMarker) mapPreview.removeLayer(scanMarker);
                if (locationCircle) mapPreview.removeLayer(locationCircle);
            }
            closeModal(mapPreviewModal);
        });

        async function initializePatrolMap(task) {
            openModal(patrolMapModal);
            patrolPointMarkers = {}; // Reset markers
            const buttonsContainer = document.getElementById('patrol-point-buttons');
            if (buttonsContainer) {
                buttonsContainer.innerHTML = '';
                // 在窄螢幕中加大底部內距與背景不透明度，提升可見性
                buttonsContainer.style.padding = '10px';
                buttonsContainer.style.background = 'rgba(255,255,255,0.95)';
                buttonsContainer.style.boxShadow = '0 -2px 8px rgba(0,0,0,0.08)';
                buttonsContainer.style.zIndex = '6000';
            }

            // 僅取「當次時段」的巡邏紀錄：以排程時間為中心建立時間窗口
            const now = new Date();
            const todayIndex = now.getDay();
            const scheduledVal = task.weeklyTimes && task.weeklyTimes[todayIndex] ? task.weeklyTimes[todayIndex] : null;
            let windowStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
            let windowEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
            if (scheduledVal) {
                if (typeof scheduledVal === 'string') {
                    const [hh, mm] = scheduledVal.split(":").map(Number);
                    const scheduled = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh || 0, mm || 0, 0, 0);
                    windowStart = new Date(scheduled.getTime() - 120 * 60 * 1000);
                    windowEnd = new Date(scheduled.getTime() + 120 * 60 * 1000);
                } else {
                    // 使用 start/end 作為窗口，允許提前/延後小緩衝（各加減15分鐘）
                    const [sh, sm] = (scheduledVal.start || '00:00').split(":").map(Number);
                    const [eh, em] = (scheduledVal.end || '23:59').split(":").map(Number);
                    windowStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), sh || 0, sm || 0, 0, 0);
                    windowEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), eh || 23, em || 59, 59, 999);
                    // 緩衝
                    windowStart = new Date(windowStart.getTime() - 15 * 60 * 1000);
                    windowEnd = new Date(windowEnd.getTime() + 15 * 60 * 1000);
                }
            }
            const logsQuery = query(collection(db, "patrol_logs"),
                where("scheduleId", "==", task.id),
                where("timestamp", ">=", Timestamp.fromDate(windowStart)),
                where("timestamp", "<=", Timestamp.fromDate(windowEnd))
            );
            const logsSnapshot = await getDocs(logsQuery);
            const completedPointIds = new Set();
            logsSnapshot.forEach(doc => {
                completedPointIds.add(doc.data().patrolPointId);
            });

            const redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });

            const greenIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });

            if (!patrolMap) {
                patrolMap = L.map('patrol-map-container');
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(patrolMap);
            } else {
                Object.values(patrolPointMarkers).forEach(marker => patrolMap.removeLayer(marker));
            }
            
            const points = task.patrolPoints || [];
            if (points.length === 0) {
                alert('此巡邏任務尚未設定任何巡邏點。');
                closeModal(patrolMapModal);
                return;
            }

            const bounds = L.latLngBounds();
            points.forEach(point => {
                const coords = point.location.split(',').map(Number);
                if (coords.length === 2 && !isNaN(coords[0])) {
                    const isCompleted = completedPointIds.has(point.internalId);
                    const icon = isCompleted ? greenIcon : redIcon;

                    const marker = L.marker(coords, { icon: icon }).addTo(patrolMap);
                    marker.bindPopup(`<b>${point.name}</b><br>${point.code}`);
                    if (!isCompleted) {
                        marker.on('click', () => {
                            document.getElementById('nfc-scan-point-name').textContent = `掃描: ${point.name}`;
                            nfcScanLog.innerHTML = '';
                            openModal(nfcPointScanModal);
                            startNFCScan(point);
                        });
                    }
                    patrolPointMarkers[point.internalId] = marker;
                    bounds.extend(coords);

                    // 生成巡邏點列表按鈕
                    if (buttonsContainer) {
                        const btn = document.createElement('button');
                        btn.className = `px-3 py-2 text-sm rounded border whitespace-nowrap ${isCompleted ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                        btn.textContent = `${point.code} ${point.name}`;
                        btn.style.flexShrink = '0';
                        btn.addEventListener('click', () => {
                            patrolMap.setView(coords, Math.max(patrolMap.getZoom(), 18));
                            marker.openPopup();
                            // 未完成的巡邏點，直接開啟 NFC 掃描視窗
                            if (!isCompleted) {
                                document.getElementById('nfc-scan-point-name').textContent = `掃描: ${point.name}`;
                                nfcScanLog.innerHTML = '';
                                openModal(nfcPointScanModal);
                                startNFCScan(point);
                            }
                        });
                        buttonsContainer.appendChild(btn);
                    }
                }
            });

            if (bounds.isValid()) {
                // 先套用邊界，讓所有點可見
                patrolMap.fitBounds(bounds, { padding: [20, 20], maxZoom: 18 });

                // 依據邊界範圍自動提升縮放，避免點太擠
                const sw = bounds.getSouthWest();
                const ne = bounds.getNorthEast();
                const diagonalMeters = sw.distanceTo(ne);
                // 小範圍：加大縮放至 18；中範圍：至少 17
                if (diagonalMeters < 1500) {
                    patrolMap.setZoom(18);
                } else if (diagonalMeters < 3000) {
                    patrolMap.setZoom(Math.max(patrolMap.getZoom(), 17));
                }
            }
            setTimeout(() => patrolMap.invalidateSize(), 100);
        }

        function updatePatrolMapMarker(pointId, isCompleted) {
            const marker = patrolPointMarkers[pointId];
            if (marker) {
                const greenIcon = new L.Icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                });
                if (isCompleted) {
                    marker.setIcon(greenIcon);
                    marker.off('click'); // Disable click after completion
                }
            }
        }


        // --- 功能性事件監聽 ---
        togglePasswordBtn.addEventListener('click', () => {
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';
            eyeIcon.classList.toggle('hidden', isPassword);
            eyeOffIcon.classList.toggle('hidden', !isPassword);
        });

        function checkRememberedEmail() {
            const rememberedEmail = localStorage.getItem('rememberedEmail');
            if (rememberedEmail) {
                emailInput.value = rememberedEmail;
                rememberMeCheckbox.checked = true;
            }
        }

        // --- 首頁時間列：每秒更新目前日期時間（含秒） ---
        function startClockBar() {
            const el = document.getElementById('current-time-text');
            if (!el) return;
            const update = () => {
                const now = new Date();
                const y = now.getFullYear();
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const d = String(now.getDate()).padStart(2, '0');
                const hh = String(now.getHours()).padStart(2, '0');
                const mm = String(now.getMinutes()).padStart(2, '0');
                const ss = String(now.getSeconds()).padStart(2, '0');
                el.textContent = `${y}-${m}-${d} ${hh}:${mm}:${ss}`;
            };
            update();
            setInterval(update, 1000);
        }

        // --- 初始化檢查 ---
        checkNFCSupport();
        checkRememberedEmail();
        startClockBar();
    </script>
</body>
</html>