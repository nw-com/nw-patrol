<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>西北保全巡邏打卡系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 基本樣式 */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { -webkit-tap-highlight-color: transparent; background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .main-container { height: calc(100vh - 40px); width: calc(100vw - 20px); margin: 20px 10px; }
        .page-content { height: calc(100% - 140px); }
        .nav-btn-active { background-color: #3b82f6; color: white; }
        .log-item, .list-item { transition: transform 0.2s; }
        .log-item:hover, .list-item:hover { transform: scale(1.02); }
        /* 隱藏滾動條 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="flex items-center justify-center">

    <!-- 登入頁面 -->
    <div id="login-page" class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
        <h2 class="text-3xl font-bold text-center text-gray-900">西北保全巡邏打卡系統</h2>
        <div>
            <label for="email" class="text-sm font-medium text-gray-700">帳號 (電子郵件)</label>
            <input id="email" name="email" type="email" autocomplete="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
            <label for="password" class="text-sm font-medium text-gray-700">密碼</label>
            <input id="password" name="password" type="password" autocomplete="current-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        <p id="login-error" class="text-red-500 text-sm text-center"></p>
        <button id="login-button" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            登入
        </button>
    </div>

    <!-- 主應用程式容器 -->
    <div id="app-container" class="main-container bg-white rounded-xl shadow-2xl flex-col max-w-lg mx-auto overflow-hidden hidden">
        
        <!-- 頁首 -->
        <header id="app-header" class="flex-shrink-0 flex items-center justify-between p-4" style="height: 70px;">
            <h1 class="text-2xl font-bold text-gray-800"></h1>
            <button id="logout-button" class="text-gray-500 hover:text-red-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
            </button>
        </header>

        <!-- 頁中 (主要內容區域) -->
        <main class="flex-grow overflow-y-auto p-4 bg-gray-50 no-scrollbar" style="height: calc(100% - 140px);">
            <!-- 首頁內容 -->
            <div id="page-home" class="hidden h-full">
                <div class="flex flex-col items-center justify-center h-full text-center">
                    <div id="clock-date" class="text-xl text-gray-600"></div>
                    <div id="clock-time" class="text-7xl font-bold text-gray-800 tracking-wider"></div>
                    <div class="mt-4 text-gray-700">歡迎, <span id="user-name-display" class="font-semibold"></span>!</div>
                </div>
            </div>

            <!-- 巡邏頁內容 -->
            <div id="page-patrol" class="hidden">
                 <!-- 狀態顯示卡... -->
            </div>

            <!-- 資料頁內容 -->
            <div id="page-data" class="hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b-2 pb-2">歷史巡邏紀錄</h2>
                <div id="data-log-container" class="space-y-3">
                    <p class="text-center text-gray-500 py-4">正在載入紀錄...</p>
                </div>
            </div>

            <!-- 設定頁內容 -->
            <div id="page-settings" class="hidden">
                <!-- 社區管理 -->
                <div class="mb-8">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">社區管理</h2>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex gap-2 mb-4">
                            <input id="community-name-input" type="text" placeholder="輸入新的社區名稱" class="flex-grow border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <button id="add-community-button" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">新增</button>
                        </div>
                        <div id="community-list" class="space-y-2"></div>
                    </div>
                </div>
                
                <!-- 帳號管理 -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">帳號管理</h2>
                    <div class="bg-white p-4 rounded-lg shadow">
                         <p class="text-sm text-gray-600 mb-4">
                            <strong>重要提示:</strong> 帳號的新增與密碼設定，請至 Firebase 後台操作。此處僅顯示已在 Firestore 建立對應資料的帳號。
                        </p>
                        <div id="user-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 頁尾 -->
        <footer class="flex-shrink-0 grid grid-cols-4 gap-2 p-2" style="height: 70px;">
            <button data-page="home" class="nav-btn flex flex-col items-center justify-center rounded-lg transition-colors">
                <span>首頁</span>
            </button>
            <button data-page="patrol" class="nav-btn flex flex-col items-center justify-center rounded-lg transition-colors">
                <span>巡邏</span>
            </button>
            <button data-page="data" class="nav-btn flex flex-col items-center justify-center rounded-lg transition-colors">
                <span>資料</span>
            </button>
            <button data-page="settings" class="nav-btn flex flex-col items-center justify-center rounded-lg transition-colors">
                <span>設定</span>
            </button>
        </footer>
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // 匯入 Firebase 模組
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, onSnapshot, addDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase 設定 ---
        // 重要：請將下方的 firebaseConfig 換成您自己的 Firebase 專案設定
        const firebaseConfig = {
  apiKey: "AIzaSyBaBL7rKPnqpz8hbfILWq6cDWdZust13xM",
  authDomain: "nw-patrol.firebaseapp.com",
  projectId: "nw-patrol",
  storageBucket: "nw-patrol.firebasestorage.app",
  messagingSenderId: "157808049159",
  appId: "1:157808049159:web:6f9128d16cb9919d50bea2",
  measurementId: "G-44B5L4KH1Q"
};

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUserProfile = null; // 用於儲存登入者的資料

        // --- 全域元素選擇器 ---
        const loginPage = document.getElementById('login-page');
        const appContainer = document.getElementById('app-container');
        const loginButton = document.getElementById('login-button');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        const userNameDisplay = document.getElementById('user-name-display');
        
        // --- 導覽相關 ---
        const pageElements = {
            home: document.getElementById('page-home'),
            patrol: document.getElementById('page-patrol'),
            data: document.getElementById('page-data'),
            settings: document.getElementById('page-settings'),
        };
        const navButtons = document.querySelectorAll('.nav-btn');
        const headerTitle = document.querySelector('#app-header h1');
        
        // --- 監聽認證狀態 ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // 使用者已登入
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    currentUserProfile = { uid: user.uid, ...userDocSnap.data() };
                    userNameDisplay.textContent = currentUserProfile.name || '使用者';
                    setupUIForUser(currentUserProfile);
                    loginPage.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    appContainer.classList.add('flex');
                    showPage('home'); // 登入後預設顯示首頁
                } else {
                    // Firestore 中沒有此使用者的資料
                    loginError.textContent = '找不到使用者設定檔，請聯繫管理員。';
                    await signOut(auth);
                }
            } else {
                // 使用者已登出
                currentUserProfile = null;
                loginPage.classList.remove('hidden');
                appContainer.classList.add('hidden');
                appContainer.classList.remove('flex');
            }
        });
        
        // --- 登入邏輯 ---
        loginButton.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            loginError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged 會處理後續 UI 變化
            } catch (error) {
                loginError.textContent = '帳號或密碼錯誤。';
                console.error("Login failed:", error);
            }
        });

        // --- 登出邏輯 ---
        logoutButton.addEventListener('click', async () => {
            await signOut(auth);
        });

        // --- 根據使用者角色設定UI ---
        function setupUIForUser(profile) {
            const roles = {
                '管理員': ['home', 'patrol', 'data', 'settings'],
                '高階主管': ['home', 'patrol', 'data'],
                '總幹事': ['home', 'patrol', 'data'],
                '保全': ['home', 'patrol', 'data']
            };
            const allowedPages = roles[profile.role] || [];
            
            navButtons.forEach(btn => {
                const page = btn.dataset.page;
                if (allowedPages.includes(page)) {
                    btn.classList.remove('hidden');
                } else {
                    btn.classList.add('hidden');
                }
            });
            // 重新計算 grid-cols
            const visibleButtons = allowedPages.length;
            const footer = document.querySelector('footer');
            footer.className = `flex-shrink-0 grid grid-cols-${visibleButtons} gap-2 p-2`;
        }

        // --- 導覽邏輯 ---
        function showPage(pageName) {
            Object.values(pageElements).forEach(page => page.classList.add('hidden'));
            if (pageElements[pageName]) {
                pageElements[pageName].classList.remove('hidden');
            }

            const titles = { home: '首頁', patrol: '巡邏打卡', data: '歷史紀錄', settings: '系統設定' };
            headerTitle.textContent = titles[pageName] || '保全系統';

            navButtons.forEach(btn => {
                btn.classList.toggle('nav-btn-active', btn.dataset.page === pageName);
            });
            
            // 根據頁面載入特定資料
            if(pageName === 'settings' && currentUserProfile.role === '管理員') {
                loadCommunities();
                loadUsers();
            }
            if(pageName === 'data'){
                loadDataLogs();
            }
        }
        navButtons.forEach(btn => btn.addEventListener('click', () => showPage(btn.dataset.page)));
        
        // --- 設定頁邏輯 (僅管理員) ---
        const communityNameInput = document.getElementById('community-name-input');
        const addCommunityButton = document.getElementById('add-community-button');
        const communityList = document.getElementById('community-list');
        const userList = document.getElementById('user-list');

        addCommunityButton.addEventListener('click', async () => {
            const name = communityNameInput.value.trim();
            if (name) {
                await addDoc(collection(db, "communities"), { name: name });
                communityNameInput.value = '';
            }
        });

        function loadCommunities() {
            onSnapshot(collection(db, "communities"), (snapshot) => {
                communityList.innerHTML = '';
                snapshot.forEach(doc => {
                    const item = document.createElement('div');
                    item.className = 'list-item flex justify-between items-center p-2 bg-gray-100 rounded';
                    item.textContent = doc.data().name;
                    communityList.appendChild(item);
                });
            });
        }
        
        function loadUsers() {
            onSnapshot(collection(db, "users"), (snapshot) => {
                userList.innerHTML = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const item = document.createElement('div');
                    item.className = 'list-item p-2 bg-gray-100 rounded';
                    item.innerHTML = `
                        <p class="font-semibold">${user.name} (${user.role})</p>
                        <p class="text-sm text-gray-600">${user.email}</p>
                    `;
                    userList.appendChild(item);
                });
            });
        }
        
        // --- 資料頁邏輯 ---
        function loadDataLogs() {
            const dataLogContainer = document.getElementById('data-log-container');
            let q;
            if (currentUserProfile.role === '管理員') {
                q = query(collection(db, "logs"), orderBy("timestamp", "desc"));
            } else {
                 q = query(collection(db, "logs"), where("communityIds", "array-contains-any", currentUserProfile.communities), orderBy("timestamp", "desc"));
            }
            
            onSnapshot(q, (snapshot) => {
                dataLogContainer.innerHTML = '';
                if(snapshot.empty){
                    dataLogContainer.innerHTML = '<p class="text-center text-gray-500 py-4">沒有任何歷史紀錄</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const log = doc.data();
                    const item = document.createElement('div');
                    item.className = 'log-item bg-white p-3 rounded-lg shadow-sm';
                    item.innerHTML = `
                        <div>
                           <p class="font-semibold">${log.location}</p>
                           <p class="text-sm text-gray-500">${new Date(log.timestamp.seconds * 1000).toLocaleString()}</p>
                           <p class="text-xs text-gray-400">by ${log.userName}</p>
                        </div>
                    `;
                    dataLogContainer.appendChild(item);
                });
            });
        }

        // --- 初始化 ---
        const clockDateEl = document.getElementById('clock-date');
        const clockTimeEl = document.getElementById('clock-time');
        function updateClock() {
            const now = new Date();
            clockDateEl.textContent = now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            clockTimeEl.textContent = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        }
        updateClock();
        setInterval(updateClock, 1000);
    </script>
</body>
</html>
