<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>西北保全巡邏打卡系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LeafletJS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        /* 基本樣式 */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { -webkit-tap-highlight-color: transparent; background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .main-container { height: calc(100vh - 40px); width: calc(100vw - 20px); margin: 20px 10px; }
        .page-content { height: calc(100% - 140px); }
        .nav-btn-active { background-color: #ef4444; color: white; } /* Red-500 */
        .log-item, .list-item { transition: transform 0.2s; }
        .log-item:hover, .list-item:hover { transform: scale(1.02); }
        /* 隱藏滾動條 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Loading Spinner */
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #ef4444; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Map Styles */
        .map-container { height: 200px; width: 100%; border-radius: 0.5rem; border: 1px solid #ddd; }
        #patrol-map { height: 100%; width: 100%; }
        .leaflet-marker-icon.completed-marker { filter: hue-rotate(90deg) saturate(1.5); } /* Red -> Green */
    </style>
</head>
<body class="flex items-center justify-center">

    <!-- 登入頁面 -->
    <div id="login-page" class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
        <div class="mx-auto h-12 w-12 text-red-600">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
        </div>
        <h2 class="text-3xl font-bold text-center text-gray-900">西北保全巡邏打卡系統</h2>
        <div>
            <div class="flex items-center justify-between">
                <label for="email" class="text-sm font-medium text-gray-700">帳號 (電子郵件)</label>
                <div class="flex items-center">
                    <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                    <label for="remember-me" class="ml-2 block text-sm text-gray-900">記住我</label>
                </div>
            </div>
            <input id="email" name="email" type="email" autocomplete="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500">
        </div>
        <div>
            <label for="password" class="text-sm font-medium text-gray-700">密碼</label>
            <div class="relative mt-1">
                <input id="password" name="password" type="password" autocomplete="current-password" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500">
                <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-700">
                    <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                    <svg id="eye-off-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye-off hidden"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                </button>
            </div>
        </div>
        <p id="login-error" class="text-red-500 text-sm text-center h-5"></p>
        <button id="login-button" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
            登入
        </button>
    </div>

    <!-- 主應用程式容器 -->
    <div id="app-container" class="main-container bg-white rounded-xl shadow-2xl flex-col max-w-lg mx-auto overflow-hidden hidden">
        
        <!-- 頁首 -->
        <header id="app-header" class="flex-shrink-0 flex items-center justify-between p-4 border-b" style="height: 70px;">
            <div class="flex items-center gap-3">
                <div class="h-8 w-8 text-red-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                </div>
                <h1 id="header-title" class="text-xl font-bold text-gray-900">西北保全巡邏打卡系統</h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-sm text-gray-700 whitespace-nowrap">歡迎, <span id="user-name-display" class="font-semibold"></span>!</div>
                <button id="logout-button" class="text-gray-500 hover:text-red-500 transition-colors" title="登出">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                </button>
            </div>
        </header>


        <!-- 頁中 (主要內容區域) -->
        <main class="flex-grow overflow-y-auto p-4 bg-gray-50 no-scrollbar" style="height: calc(100% - 140px);">
            <!-- 首頁內容 -->
            <div id="page-home" class="hidden h-full">
                <div class="flex flex-col items-center justify-center h-full text-center">
                    <div id="clock-date" class="text-xl text-gray-600"></div>
                    <div id="clock-time" class="text-7xl font-bold text-gray-800 tracking-wider"></div>
                </div>
            </div>

            <!-- 巡邏頁內容 -->
            <div id="page-patrol" class="hidden h-full flex flex-col">
                <div id="patrol-community-selection" class="w-full space-y-3"></div>

                <div id="patrol-schedule-selection" class="w-full space-y-3 hidden"></div>

                <div id="patrol-main-view" class="w-full h-full flex-col hidden">
                    <div class="flex border-b mb-2">
                        <button data-tab="map" class="patrol-tab-btn flex-1 p-2 text-center font-medium border-b-2 border-red-500 text-red-600">巡邏地圖</button>
                        <button data-tab="log" class="patrol-tab-btn flex-1 p-2 text-center font-medium border-b-2 border-transparent text-gray-500">本次巡邏紀錄</button>
                    </div>
                    <div id="patrol-map-tab" class="flex-grow h-full w-full">
                        <div id="patrol-map" class="h-full w-full rounded-md"></div>
                    </div>
                    <div id="patrol-log-tab" class="hidden h-full overflow-y-auto">
                         <div id="log-container" class="space-y-3"></div>
                    </div>
                </div>
            </div>

            <!-- 資料頁內容 -->
            <div id="page-data" class="hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b-2 pb-2">歷史巡邏紀錄</h2>
                <div id="data-log-container" class="space-y-3">
                    <p class="text-center text-gray-500 py-4">正在載入紀錄...</p>
                </div>
            </div>

            <!-- 設定頁內容 -->
            <div id="page-settings" class="hidden">
                <!-- 社區管理 -->
                <div class="mb-8">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">社區管理</h2>
                    <div class="bg-white p-4 rounded-lg shadow">
                         <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium text-gray-800">現有社區列表</h3>
                            <button id="show-add-community-modal-button" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 text-sm font-medium">新增社區</button>
                         </div>
                        <div id="community-list" class="space-y-2"></div>
                    </div>
                </div>
                
                <!-- 帳號管理 -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">帳號管理</h2>
                    <div class="bg-white p-4 rounded-lg shadow">
                         <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium text-gray-800">現有帳號列表</h3>
                            <button id="show-add-user-modal-button" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 text-sm font-medium">新增帳號</button>
                         </div>
                        <div id="user-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 頁尾 -->
        <footer class="flex-shrink-0 grid grid-cols-4 gap-2 p-2" style="height: 70px;">
            <button data-page="home" class="nav-btn flex flex-col items-center justify-center rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                <span>首頁</span>
            </button>
            <button data-page="patrol" class="nav-btn flex flex-col items-center justify-center rounded-lg transition-colors">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><path d="m9 16 2 2 4-4"/></svg>
                <span>巡邏</span>
            </button>
            <button data-page="data" class="nav-btn flex flex-col items-center justify-center rounded-lg transition-colors">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V10H6V4h6v6h6v10Z"/><path d="M18 20V4h6v16h-6Z"/><path d="M6 20V10H0v10h6Z"/></svg>
                <span>資料</span>
            </button>
            <button data-page="settings" class="nav-btn flex flex-col items-center justify-center rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                <span>設定</span>
            </button>
        </footer>
    </div>

    <!-- Modals -->
    <div id="add-community-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-full overflow-y-auto no-scrollbar">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <h3 class="text-xl font-semibold text-gray-800">新增社區</h3>
                    <button id="close-add-community-modal-button" class="text-gray-400 hover:text-gray-800 text-3xl font-light">&times;</button>
                </div>
                <form id="add-community-form" class="space-y-4">
                    <div>
                        <label class="text-sm font-medium text-gray-700">社區名稱</label>
                        <input id="new-community-name-input" type="text" required class="mt-1 block w-full input">
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">社區中心位置 (在地圖上點擊設定)</label>
                        <div id="community-map-container" class="map-container mt-1"></div>
                        <input type="hidden" id="community-lat-input">
                        <input type="hidden" id="community-lng-input">
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">巡邏點</h4>
                        <div id="patrol-points-container" class="space-y-3"></div>
                        <button type="button" id="add-patrol-point-button" class="mt-3 text-sm text-red-600 hover:text-red-800 font-medium">+ 新增巡邏點</button>
                    </div>
                     <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">固定每日巡邏時間</h4>
                        <div id="schedule-container" class="space-y-3"></div>
                        <button type="button" id="add-schedule-button" class="mt-3 text-sm text-red-600 hover:text-red-800 font-medium">+ 新增排班</button>
                    </div>
                    <p id="add-community-error" class="text-red-500 text-sm text-center h-5"></p>
                    <button type="submit" class="w-full flex justify-center items-center py-2 px-4 button-primary">儲存社區</button>
                </form>
            </div>
        </div>
    </div>
    <div id="add-user-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <!-- User Modal Content -->
    </div>
    <div id="nfc-scan-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <!-- NFC Scan Modal Content -->
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Firebase and other logic will go here
    </script>
</body>
</html>
